---
title: "Tregs"
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
---

#{.tabset}

##Background
Tregs definition commonly followed across the studies is CD3+CD4+CD25+ cells. SDY80, SDY404, SDY312, SDY514, SDY202, SDY739 were used from [ImmPort database](https://www.immport.org/shared/search)

[This paper](https://www.tandfonline.com/doi/full/10.4161/hv.21117) shows an increased frequency of CD4+ CD25+ expression (study not on ImmPort).

All the cell proportions are calculated based on CD3+ cells as the parent.
```{r, include=FALSE,message=FALSE}
library(ggplot2)
library(reshape2)
library(dplyr)
library(RImmPort)
library(DBI)
library(plyr)
library(RSQLite)
library(openxlsx)
library(kableExtra)
library(knitr)
library(shiny)
library(psych)
library(gridExtra)
library(ggpubr)
library(lme4)
library(IDPmisc)
```

```{r, include=FALSE}
summary_table <- data.frame(
  Studies=c("SDY67","SDY80","SDY404","SDY416","SDY312","SDY514","SDY202","SDY739","SDY33"),
  TimePoints=c("Day0, Day3, Day28, Day75","Day -7, Day0, Day1, Day7, Day70", "Day0, Day2, Day3, Day4, Day7, Day11, Day28, Day35","Day0, Day1, Day7, Day 14 and Day28","Day0","Day0","Day0","Day0","Day0, Day90, Day180, Day270, Day360, Day540, Day720"),
  NumberOfSubjects=c("149","61","53","45","76","73","78","126","151"),
Neutralization=c("Yes (for Day 0, Day 3,  Day28, Day75)","Yes (for Day -7, Day0 and Day 28)","No","No","No","No","No","Yes (for Day 0 , Day7 and Day 28)","No"),
  HAI=c("No","No","Yes","No","Yes","Yes","Yes","No","No"),
GeneExpressionData = c("Yes (RNA-seq)","No","No","No","Yes (MA)","No","No","Yes (MA)","No")
)
```

```{r,echo=FALSE, results=TRUE}
kable(summary_table) %>%
  kable_styling(full_width = F) %>%
  row_spec(c(4,9),background = "gray") %>%
  column_spec(1:ncol(summary_table),border_left = T, border_right = T)
```


##SD67
[SDY67](https://www.immport.org/shared/study/SDY67) has files for 144 subjects with CD25 and CD4 markers

MetaData is extracted from the ImmPort data schema by querying the local database. First we build a local SQLite database instance and then query the database. The table below shows the first 5 rows of filtered out data. 
```{r, include=FALSE, message=FALSE, warning=FALSE}
sdy <- "SDY67"
##Set tab_dir to the folder where the study files are located
studies_dir <- file.path(paste0("./Spreadsheets/SDY67_Study/"))
tab_dir <- file.path(studies_dir,"Tab")
list.files(tab_dir)

##Set db dir to the folder where the database file "ImmPort.sqlite" should be stored
db_dir <- file.path(studies_dir,"Db")

##Build a local SQLite ImmPort database instance
#buildNewSqliteDb(tab_dir, db_dir)  ##Already built
list.files(db_dir)

######
sqlite_conn <- dbConnect(SQLite(), dbname=file.path(db_dir, "ImmPort.sqlite"))
setImmPortDataSource(sqlite_conn)
getListOfStudies()
```

```{r, include=FALSE, message=FALSE, warning=FALSE}
fcs_meta_Data <- dbGetQuery(sqlite_conn,"SELECT a.name, a.file_info_id, b.expsample_accession, b.file_info_id,
                            c.biosample_accession, c.expsample_accession, 
                            d.biosample_accession, d.study_time_collected, d.subject_accession,d.type,
                            e.subject_accession, e.max_subject_age
                            FROM file_info a
                            INNER JOIN expsample_2_file_info b
                            ON a.file_info_id = b.file_info_id
                            INNER JOIN expsample_2_biosample c
                            ON c.expsample_accession = b.expsample_accession
                            INNER JOIN biosample d
                            ON d.biosample_accession = c.biosample_accession
                            INNER JOIN arm_2_subject e
                            ON e.subject_accession = d.subject_accession
                            AND a.name LIKE '%.fcs%'
                            AND a.name NOT LIKE '%Compensation%';")
```

```{r,echo=FALSE, results=TRUE}
head(fcs_meta_Data)
```

```{r, include=FALSE, warning=FALSE, message=FALSE}
header_info <- read.xlsx("./Spreadsheets/Header_SDY67.xlsx")                            
colnames(header_info)[1] <- "name" 
mm_sdy67 <- merge(fcs_meta_Data, header_info, by="name")
final_tab_sdy67 <- mm_sdy67[which(mm_sdy67$Panel == 1),]
```

```{r, include=FALSE, warning=FALSE, message=FALSE}
ab_titer_sdy67 <- read.delim("./Spreadsheets/SDY67_Study/Tab/SDY67-DR29_Tab/Tab/hai_result.txt",stringsAsFactors = FALSE,sep="\t",header=TRUE)
#ab_titer <- ab_titer[which(ab_titer$STUDY_TIME_COLLECTED == '0'),]
ab_titer_d_sdy67 <- dcast(ab_titer_sdy67,SUBJECT_ACCESSION+STUDY_TIME_COLLECTED~VIRUS_STRAIN_PREFERRED,value.var='VALUE_REPORTED')
ab_titer_d_sdy67$Geometric_mean <- apply(ab_titer_d_sdy67[,3:4],1,function(x) geometric.mean(x,na.rm=TRUE))
resp_sdy67 <- dcast(ab_titer_d_sdy67,SUBJECT_ACCESSION~STUDY_TIME_COLLECTED,value.var='Geometric_mean')
resp_sdy67$FoldChange <- resp_sdy67$`28`/resp_sdy67$`0`
resp_sdy67$responder0 <- cut(resp_sdy67$`0`, breaks = c(0,40,max(resp_sdy67$`0`)), labels=c("NonResponder","Responder"))
resp_sdy67$responder28 <- cut(resp_sdy67$`28`, breaks = c(0,40,max(na.omit(resp_sdy67$`28`))), labels=c("NonResponder","Responder"))
resp_sdy67$responderFC <- cut(resp_sdy67$FoldChange, breaks = c(0,4,max(na.omit(resp_sdy67$FoldChange))), labels = c("NonResponder","Responder"))
resp_sdy67$responder_Day0_FC <- ifelse(resp_sdy67$responder0 == "Responder" | resp_sdy67$responderFC == "Responder","Responder","NonResponder")
colnames(resp_sdy67)[1] <- "subject_accession"
melt_response_sdy67 <- melt(resp_sdy67[,c(1,2,3,4,5,7,8)],id=c("subject_accession","responder0","responder28"))
```

Antibody titer for SDY67:
Responders vs Non-responders: titer >= 40 are responders and titer < 40 are non-responders at Day28. Fold change is calculated as $\frac{"Geometric mean of Ab titer of all strains on Day 28"}{Geometric mean of Ab titer of all strains on Day 0}$. 
```{r,echo=FALSE, results=TRUE}
kable(resp_sdy67)%>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "500px")
```

Line Plots for ab-titer across the time points. Colors indicate responder or non-responder based on Day28 titer (> 40 is a responder)
```{r,echo=FALSE, results=TRUE}
ggplot(na.omit(melt_response_sdy67),aes(x=variable,y=value,group=subject_accession,color=responder28))+geom_line()+geom_point()+xlab("Day")+ylab("titer")+ggtitle("Antibody response across time points")+theme(text=element_text(size=10,family="Times"))
```

Tregs population proportions: Plots below show the proportions of Tregs across time points. In each plot the colors indicate responder or non-responder based on ab-titer at each time point of titer. (> 40 is a responder)

```{r, include=FALSE, message=FALSE, warning=FALSE}
#Reading the population percentages
sdy <- read.xlsx("./Spreadsheets/SDY67_Percentages.xlsx",sheet=5)
colnames(sdy)[1] <- "name"
sdy67 <- merge(sdy,final_tab_sdy67,by="name")[,-c(3,4,8,12,14,15,16)]
sdy67$study_time_collected <- paste0("Day_",sdy67$study_time_collected)
cast_sdy67 <- dcast(na.omit(sdy67),subject_accession+max_subject_age~study_time_collected,value.var='Tregs',fun.aggregate = mean)
#ggplot(sdy80,aes(x=Day,y=Tregs,group=subject_accession,color=subject_accession))+geom_line()
cast_sdy67 <- cast_sdy67[cast_sdy67$subject_accession %in% resp_sdy67$subject_accession,]
data_sdy67 <- left_join(cast_sdy67,resp_sdy67,by='subject_accession')
data_sdy67$Age_cat <- cut(data_sdy67$max_subject_age, breaks = c(0,60,120), labels = c("young","old"))

melt_data_sdy67 <- melt(data_sdy67[,-c(14,15)],id=c("subject_accession","max_subject_age","0","3","28","75","FoldChange","responder0","responder28","Age_cat"))
melt_data_sdy67$value <- as.numeric(melt_data_sdy67$value)
```

```{r,echo=FALSE, results=TRUE}
tab_sdy67 <- table(data_sdy67$Age_cat,data_sdy67$responder0)

kable(tab_sdy67) %>%
  kable_styling() %>%
  column_spec(c(1:2),border_right = TRUE, border_left = TRUE)

mlt_sdy67 <- melt(tab_sdy67)
ggplot(mlt_sdy67,aes(x=Var2,y=value,fill=factor(Var1)))+geom_bar(stat="identity",width = 0.3,alpha=0.6)+xlab("Response")+ylab("Number of subjects")+scale_fill_manual(values=c("deepskyblue4","brown3"),name="Age")+theme(text=element_text(size=10,family="Times"))
```


```{r,echo=FALSE, results=TRUE}
melt_data_sdy67$variable <- factor(melt_data_sdy67$variable,levels = c("Day_0","Day_3","Day_28","Day_75"))

ggplot(na.omit(melt_data_sdy67),aes(x=variable,y=value,group=subject_accession,color=responder28))+geom_line(aes(linetype=Age_cat))+geom_point()+xlab("Day (for Cell proportion)")+ylab("Cell proportion")+ggtitle("Cell Proportions across time points (Response based on Day 28)")+theme(text=element_text(size=10,family="Times"))


ggplot(na.omit(melt_data_sdy67),aes(x=responder28,y=value, color=variable))+geom_boxplot()+xlab("Response at Day28")+ylab("Cell proportion")+ggtitle("Cell Proportions across time points for response at Day28")+facet_wrap(~Age_cat)+theme(text=element_text(size=10,family="Times"))
```

```{r, include=FALSE, message=FALSE, warning=FALSE,echo=FALSE, results=TRUE}
#p1<-ggscatter(data_sdy80,x=paste0("Day_-7"),y="FoldChange",add = "reg.line", conf.int = TRUE, 
 #           cor.coef = TRUE, cor.method = "pearson",xlab="Cell Proportion", ylab="Ab Titer Fold Change",title = "Tregs at Day -7")
  p2<-ggscatter(data_sdy67,x="Day_0",y="FoldChange",add = "reg.line", conf.int = TRUE, 
            cor.coef = TRUE, cor.method = "pearson",xlab="Cell Proportion", ylab="Ab Titer Fold Change",title = "Tregs at Day 0")+theme(text=element_text(size=10,family="Times"))

  p3<-ggscatter(data_sdy67,x="Day_3",y="FoldChange",add = "reg.line", conf.int = TRUE, 
            cor.coef = TRUE, cor.method = "pearson",xlab="Cell Proportion", ylab="Ab Titer Fold Change",title = "Tregs at Day 3")+theme(text=element_text(size=10,family="Times"))
  
  p4<-ggscatter(data_sdy67,x="Day_28",y="FoldChange",add = "reg.line", conf.int = TRUE, 
            cor.coef = TRUE, cor.method = "pearson",xlab="Cell Proportion", ylab="Ab Titer Fold Change",title = "Tregs at Day 28")+theme(text=element_text(size=10,family="Times"))
  
 p5<-ggscatter(data_sdy67,x="Day_75",y="FoldChange",add = "reg.line", conf.int = TRUE, 
            cor.coef = TRUE, cor.method = "pearson",xlab="Cell Proportion", ylab="Ab Titer Fold Change",title = "Tregs at Day 75")+theme(text=element_text(size=10,family="Times"))
``` 

```{r, warning=FALSE, message=FALSE,echo=FALSE, results=TRUE}
 grid.arrange(p2,p3,p4,p5, ncol=2)
```

##SDY80
[SDY80](https://www.immport.org/shared/study/SDY80) - Cellular and molecular characterization of the immune response in healthy NIH employees at baseline and after immunization with the H1N1 or seasonal influenza vaccines.
Related published article can be accessed [here](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4139290/pdf/nihms-580872.pdf).

MetaData is extracted from the ImmPort data schema by querying the local database. First we build a local SQLite database instance and then query the database. The table below shows the filtered out data.
```{r, include=FALSE, message=FALSE, warning=FALSE}
sdy <- "SDY80"
##Set tab_dir to the folder where the study files are located
studies_dir <- file.path(paste0("./Spreadsheets/SDY80_Study"))
tab_dir <- file.path(studies_dir,"Tab")
list.files(tab_dir)

##Set db dir to the folder where the database file "ImmPort.sqlite" should be stored
db_dir <- file.path(studies_dir,"Db")

##Build a local SQLite ImmPort database instance
#buildNewSqliteDb(tab_dir, db_dir)  ##Already built
list.files(db_dir)

######
sqlite_conn <- dbConnect(SQLite(), dbname=file.path(db_dir, "ImmPort.sqlite"))
setImmPortDataSource(sqlite_conn)
getListOfStudies()
```

 
```{r, include=FALSE, message=FALSE, warning=FALSE}
fcs_meta_Data <- dbGetQuery(sqlite_conn,"SELECT a.name, a.file_info_id, b.expsample_accession, b.file_info_id,
                            c.biosample_accession, c.expsample_accession, 
                            d.biosample_accession, d.study_time_collected, d.subject_accession, d.type,
                            e.subject_accession, e.max_subject_age
                            FROM file_info a
                            INNER JOIN expsample_2_file_info b
                            ON a.file_info_id = b.file_info_id
                            INNER JOIN expsample_2_biosample c
                            ON c.expsample_accession = b.expsample_accession
                            INNER JOIN biosample d
                            ON d.biosample_accession = c.biosample_accession
                            INNER JOIN arm_2_subject e
                            ON e.subject_accession = d.subject_accession
                            AND a.name LIKE '%.fcs%'
                            AND a.name NOT LIKE '%Compensation%';")
```

```{r,echo=FALSE, results=TRUE}
kable(fcs_meta_Data)%>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "500px")
```


```{r,include=FALSE, message=FALSE, warning=FALSE}
fcs_meta_Data <- unique(fcs_meta_Data[,-c(3,6)])

#This file has the list of fcs files we have
header_info <- read.xlsx("./Spreadsheets/Header_SDY80.xlsx",sheet=1) 

mm_sdy80 <- merge(fcs_meta_Data, header_info, by="name")
final_tab_sdy80 <- mm_sdy80[which(mm_sdy80$Panel == "1"),]
#write.csv(final_tab[,-c(4,6,7,11,13,14,15)],"/Volumes/Samsung_T5/Immport_UH2/Companion_studies_1/SDY144/Analysis/MetaData_Tcells_SDY144.csv",row.names=FALSE)
#write.csv(final_tab[,-c(4,7,10,11)],"/Volumes/Samsung_T5/Immport_UH2/Companion_studies_1/SDY144/Analysis/MetaData_Tcells_SDY144.csv",row.names=FALSE)
```

```{r,include=FALSE,message=FALSE,warning=FALSE}
##Ab-titer values
ab_titer_sdy80 <- read.delim("/Volumes/Samsung_T5/Immport_UH2/SDY80/Study/Tab/SDY80-DR30_Tab/Tab/neut_ab_titer_result.txt",stringsAsFactors = FALSE,sep="\t",header=TRUE)

ab_titer_d_sdy80 <- dcast(ab_titer_sdy80,SUBJECT_ACCESSION+STUDY_TIME_COLLECTED~VIRUS_STRAIN_REPORTED,value.var='VALUE_REPORTED')
ab_titer_d_sdy80$Geometric_mean <- apply(ab_titer_d_sdy80[,3:9],1,function(x) geometric.mean(x,na.rm=TRUE))
resp_sdy80 <- dcast(ab_titer_d_sdy80,SUBJECT_ACCESSION~STUDY_TIME_COLLECTED,value.var='Geometric_mean')
resp_sdy80$FoldChange <- resp_sdy80$`28`/resp_sdy80$`0`
resp_sdy80$responder0 <- cut(resp_sdy80$`0`, breaks = c(0,40,max(na.omit(resp_sdy80$`0`))), labels=c("NonResponder","Responder"))
resp_sdy80$responder7 <- cut(resp_sdy80$`7`, breaks = c(0,40,max(na.omit(resp_sdy80$`7`))), labels=c("NonResponder","Responder"))
resp_sdy80$responder28 <- cut(resp_sdy80$`28`, breaks = c(0,40,max(na.omit(resp_sdy80$`28`))), labels=c("NonResponder","Responder"))
resp_sdy80$responderFC <- cut(resp_sdy80$FoldChange, breaks = c(0,4,max(na.omit(resp_sdy80$FoldChange))), labels = c("NonResponder","Responder"))
resp_sdy80$responder_Day0_FC <- ifelse(resp_sdy80$responder0 == "Responder" | resp_sdy80$responderFC == "Responder","Responder","NonResponder")
colnames(resp_sdy80)[1] <- "subject_accession"
```

Antibody titer for SDY80: 
Responders vs Non-responders: titer >= 40 are responders and titer < 40 are non-responders at Visit 0. Fold change is calculated as $\frac{"Geometric mean of Ab titer of all strains on Day 28"}{Geometric mean of Ab titer of all strains on Day 0}$. 
```{r,echo=FALSE, results=TRUE}
###Print the ab titer table
kable(resp_sdy80)%>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "500px")
```

Line Plots for ab-titer across the time points. Colors indicate responder or non-responder based on Day28 titer (> 40 is a responder)
```{r,echo=FALSE, results=TRUE}
melt_response <- melt(resp_sdy80[,c(1:6,10)],id=c("subject_accession","responder28"))
ggplot(na.omit(melt_response),aes(x=variable,y=value,group=subject_accession,color=responder28))+geom_line()+geom_point()+xlab("Day")+ylab("titer")+ggtitle("Antibody response across time points")+theme(text=element_text(size=10,family="Times"))
```

Tregs population proportions: 
Plots below show the proportions of Tregs across time points. In each plot the colors indicate responder or non-responder based on ab-titer at each time point of titer. (> 40 is a responder)
```{r, include=FALSE, message=FALSE, warning=FALSE}
#Reading the population percentages
sdy80 <- read.xlsx("./Spreadsheets/SDY80_Percentages.xlsx",sheet=2)[,c(1:7)]
sdy80$Day <- paste0("Day_",sdy80$Day)
cast_sdy80 <- dcast(sdy80,subject_accession+Age+Study~Day,value.var='Tregs',fun.aggregate = mean)
#ggplot(sdy80,aes(x=Day,y=Tregs,group=subject_accession,color=subject_accession))+geom_line()
cast_sdy80 <- cast_sdy80[cast_sdy80$subject_accession %in% resp_sdy80$subject_accession,]
data_sdy80 <- left_join(cast_sdy80,resp_sdy80,by='subject_accession')
data_sdy80$Age_cat <- cut(data_sdy80$Age, breaks = c(0,60,120), labels = c("young","old"))
melt_data_sdy80 <- melt(data_sdy80[,-c(9,13,18,19)],id=c("subject_accession","Age","Study","0","7","28","FoldChange","responder0","responder7","responder28","Age_cat"))
```

```{r,echo=FALSE, results=TRUE}
tab_sdy80 <- table(data_sdy80$Age_cat,data_sdy80$responder0)

kable(tab_sdy80) %>%
  kable_styling() %>%
  column_spec(c(1:2),border_right = TRUE, border_left = TRUE)

mlt_sdy80 <- melt(tab_sdy80)
ggplot(mlt_sdy80,aes(x=Var2,y=value,fill=factor(Var1)))+geom_bar(stat="identity",width = 0.3,alpha=0.6)+xlab("Response")+ylab("Number of subjects")+scale_fill_manual(values=c("deepskyblue4","brown3"),name="Age")+theme(text=element_text(size=10,family="Times"))

```

```{r,echo=FALSE, results=TRUE}
ggplot(na.omit(melt_data_sdy80),aes(x=variable,y=value,group=subject_accession,color=responder0))+geom_line(aes(linetype=Age_cat))+geom_point()+xlab("Day (for Cell proportion)")+ylab("Cell proportion")+ggtitle("Cell Proportions across time points (Response based on Day 0)")+theme(text=element_text(size=10,family="Times"))

ggplot(na.omit(melt_data_sdy80),aes(x=variable,y=value,group=subject_accession,color=responder7))+geom_line(aes(linetype=Age_cat))+geom_point()+xlab("Day (for Cell proportion)")+ylab("Cell proportion")+ggtitle("Cell Proportions across time points (Response based on Day 7)")+theme(text=element_text(size=10,family="Times"))

ggplot(na.omit(melt_data_sdy80),aes(x=variable,y=value,group=subject_accession,color=responder28))+geom_line(aes(linetype=Age_cat))+geom_point()+xlab("Day (for Cell proportion)")+ylab("Cell proportion")+ggtitle("Cell Proportions across time points (Response based on Day 28)")+theme(text=element_text(size=10,family="Times"))

ggplot(na.omit(melt_data_sdy80),aes(x=responder0,y=value, color=variable))+geom_boxplot()+xlab("Response at Day0")+ylab("Cell proportion")+ggtitle("Cell Proportions across time points for response at Day0")+facet_wrap(~Age_cat)+theme(text=element_text(size=10,family="Times"))

ggplot(na.omit(melt_data_sdy80),aes(x=responder7,y=value, color=variable))+geom_boxplot()+xlab("Response at Day7")+ylab("Cell proportion")+ggtitle("Cell Proportions across time points for response at Day7")+facet_wrap(~Age_cat)+theme(text=element_text(size=10,family="Times"))

ggplot(na.omit(melt_data_sdy80),aes(x=responder28,y=value, color=variable))+geom_boxplot()+xlab("Response at Day28")+ylab("Cell proportion")+ggtitle("Cell Proportions across time points for response at Day28")+facet_wrap(~Age_cat)+theme(text=element_text(size=10,family="Times"))
```


```{r, include=FALSE, message=FALSE, warning=FALSE}
p1<-ggscatter(data_sdy80,x=paste0("Day_-7"),y="FoldChange",add = "reg.line", conf.int = TRUE, 
           cor.coef = TRUE, cor.method = "pearson",xlab="Cell Proportion", ylab="Ab Titer Fold Change",title = "Tregs at Day -7")+theme(text=element_text(size=10,family="Times"))

  p2<-ggscatter(data_sdy80,x="Day_0",y="FoldChange",add = "reg.line", conf.int = TRUE, 
            cor.coef = TRUE, cor.method = "pearson",xlab="Cell Proportion", ylab="Ab Titer Fold Change",title = "Tregs at Day 0")+theme(text=element_text(size=10,family="Times"))
  
  p3<-ggscatter(data_sdy80,x="Day_1",y="FoldChange",add = "reg.line", conf.int = TRUE, 
            cor.coef = TRUE, cor.method = "pearson",xlab="Cell Proportion", ylab="Ab Titer Fold Change",title = "Tregs at Day 1")+theme(text=element_text(size=10,family="Times"))
  
  p4<-ggscatter(data_sdy80,x="Day_7",y="FoldChange",add = "reg.line", conf.int = TRUE, 
            cor.coef = TRUE, cor.method = "pearson",xlab="Cell Proportion", ylab="Ab Titer Fold Change",title = "Tregs at Day 7")+theme(text=element_text(size=10,family="Times"))
  
 p5<-ggscatter(data_sdy80,x="Day_70",y="FoldChange",add = "reg.line", conf.int = TRUE, 
            cor.coef = TRUE, cor.method = "pearson",xlab="Cell Proportion", ylab="Ab Titer Fold Change",title = "Tregs at Day 70")+theme(text=element_text(size=10,family="Times"))
 
```

```{r, message=FALSE, warning=FALSE,echo=FALSE, results=TRUE}
  grid.arrange(p2,p3,p4,p5, ncol=2)
```


```{r,  message=FALSE, warning=FALSE}
#mod <- lmer()
```

##SDY404
[SDY404](https://www.immport.org/shared/study/SDY404) Immunologic and genomic signatures of influenza vaccine response - 2011 (see companion studies SDY63, SDY400, SDY520). Realted published article can be accessed [here](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4366602/pdf/jiu573.pdf).

MetaData is extracted from the ImmPort data schema by querying the local database. First we build a local SQLite database instance and then query the database. The table below shows the filtered out data. 
```{r, include=FALSE, message=FALSE, warning=FALSE}
sdy <- "SDY404"
##Set tab_dir to the folder where the study files are located
studies_dir <- file.path(paste0("./Spreadsheets/SDY404_Study"))
tab_dir <- file.path(studies_dir,"Tab")
list.files(tab_dir)

##Set db dir to the folder where the database file "ImmPort.sqlite" should be stored
db_dir <- file.path(studies_dir,"Db")

##Build a local SQLite ImmPort database instance
#buildNewSqliteDb(tab_dir, db_dir)  ##Already built
list.files(db_dir)

######
sqlite_conn <- dbConnect(SQLite(), dbname=file.path(db_dir, "ImmPort.sqlite"))
setImmPortDataSource(sqlite_conn)
getListOfStudies()
```

```{r, include=FALSE, message=FALSE, warning=FALSE}
fcs_meta_Data <- dbGetQuery(sqlite_conn,"SELECT a.name, a.file_info_id, b.expsample_accession, b.file_info_id,
                            c.biosample_accession, c.expsample_accession, 
                            d.biosample_accession, d.study_time_collected, d.subject_accession,d.type,
                            e.subject_accession, e.max_subject_age
                            FROM file_info a
                            INNER JOIN expsample_2_file_info b
                            ON a.file_info_id = b.file_info_id
                            INNER JOIN expsample_2_biosample c
                            ON c.expsample_accession = b.expsample_accession
                            INNER JOIN biosample d
                            ON d.biosample_accession = c.biosample_accession
                            INNER JOIN arm_2_subject e
                            ON e.subject_accession = d.subject_accession
                            AND a.name LIKE '%.fcs%'
                            AND a.name NOT LIKE '%Compensation%';")
```

```{r,echo=FALSE, results=TRUE}
kable(fcs_meta_Data)%>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "500px")
```

```{r, include=FALSE, warning=FALSE, message=FALSE}
header_info <- read.xlsx("./Spreadsheets/Header_SDY404.xlsx")                            
colnames(header_info)[1] <- "name" 
mm_sdy404 <- merge(fcs_meta_Data, header_info, by="name")
final_tab_sdy404 <- mm_sdy404[which(mm_sdy404$Panel == 7),]
```

```{r, include=FALSE, warning=FALSE, message=FALSE}
ab_titer_sdy404 <- read.delim("./Spreadsheets/SDY404_Study/Tab/SDY404-DR29_Tab/Tab/hai_result.txt",stringsAsFactors = FALSE,sep="\t",header=TRUE)
#ab_titer <- ab_titer[which(ab_titer$STUDY_TIME_COLLECTED == '0'),]
ab_titer_d_sdy404 <- dcast(ab_titer_sdy404,SUBJECT_ACCESSION+STUDY_TIME_COLLECTED~VIRUS_STRAIN_PREFERRED,value.var='VALUE_REPORTED')
ab_titer_d_sdy404$Geometric_mean <- apply(ab_titer_d_sdy404[,3:5],1,function(x) geometric.mean(x,na.rm=TRUE))
resp_sdy404 <- dcast(ab_titer_d_sdy404,SUBJECT_ACCESSION~STUDY_TIME_COLLECTED,value.var='Geometric_mean')
resp_sdy404$FoldChange <- resp_sdy404$`28`/resp_sdy404$`0`
resp_sdy404$responder0 <- cut(resp_sdy404$`0`, breaks = c(0,40,max(resp_sdy404$`0`)), labels=c("NonResponder","Responder"))
resp_sdy404$responder28 <- cut(resp_sdy404$`28`, breaks = c(0,40,max(na.omit(resp_sdy404$`28`))), labels=c("NonResponder","Responder"))
resp_sdy404$responderFC <- cut(resp_sdy404$FoldChange, breaks = c(0,4,max(na.omit(resp_sdy404$FoldChange))), labels = c("NonResponder","Responder"))
resp_sdy404$responder_Day0_FC <- ifelse(resp_sdy404$responder0 == "Responder" | resp_sdy404$responderFC == "Responder","Responder","NonResponder")
colnames(resp_sdy404)[1] <- "subject_accession"
```

Antibody titer for SDY404:
Responders vs Non-responders: titer >= 40 are responders and titer < 40 are non-responders at Visit 0. Fold change is calculated as $\frac{"Geometric mean of Ab titer of all strains on Day 28"}{Geometric mean of Ab titer of all strains on Day 0}$. 
```{r,echo=FALSE, results=TRUE}
kable(resp_sdy404)%>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "500px")
```

Line Plots for ab-titer across the time points. Colors indicate responder or non-responder based on Day28 titer (> 40 is a responder)
```{r,echo=FALSE, results=TRUE}
melt_response_sdy404 <- melt(resp_sdy404[,c(1,2,4,9,10)],id=c("subject_accession","responder0","responder28"))
#ggplot(na.omit(melt_response_sdy404),aes(x=variable,y=value,group=subject_accession,color=responder0))+geom_line()
ggplot(na.omit(melt_response_sdy404),aes(x=variable,y=value,group=subject_accession,color=responder28))+geom_line()+geom_point()+xlab("Day")+ylab("titer")+ggtitle("Antibody response across time points")+theme(text=element_text(size=10,family="Times"))
```

Tregs population proportions: Plots below show the proportions of Tregs across time points. In each plot the colors indicate responder or non-responder based on ab-titer at each time point of titer. (> 40 is a responder)
```{r, include=FALSE, message=FALSE, warning=FALSE}
#Reading the population percentages
sdy404 <- read.xlsx("./Spreadsheets/SDY404_Percentages.xlsx",sheet=2)[,c(1:7)]
sdy404$Day <- paste0("Day_",sdy404$Day)
cast_sdy404 <- dcast(sdy404,subject_accession+Age+Study~Day,value.var='Tregs',fun.aggregate = mean)
#ggplot(sdy80,aes(x=Day,y=Tregs,group=subject_accession,color=subject_accession))+geom_line()
cast_sdy404 <- cast_sdy404[cast_sdy404$subject_accession %in% resp_sdy404$subject_accession,]
data_sdy404 <- left_join(cast_sdy404,resp_sdy404,by='subject_accession')
data_sdy404$Age_cat <- cut(data_sdy404$Age, breaks = c(0,60,120), labels = c("young","old"))

melt_data_sdy404 <- melt(data_sdy404[,-c(5,8:10,13,15,16,17,21,22)],id=c("subject_accession","Age","Study","0","28","FoldChange","responder0","responder28","Age_cat"))
```

```{r,echo=FALSE, results=TRUE}
tab_sdy404 <- table(data_sdy404$Age_cat,data_sdy404$responder0)

kable(tab_sdy404) %>%
  kable_styling() %>%
  column_spec(c(1:2),border_right = TRUE, border_left = TRUE)

mlt_sdy404 <- melt(tab_sdy404)
ggplot(mlt_sdy404,aes(x=Var2,y=value,fill=factor(Var1)))+geom_bar(stat="identity",width = 0.3,alpha=0.6)+xlab("Response")+ylab("Number of subjects")+scale_fill_manual(values=c("deepskyblue4","brown3"),name="Age")+theme(text=element_text(size=10,family="Times"))
```


```{r,echo=FALSE, results=TRUE}
ggplot(na.omit(melt_data_sdy404),aes(x=variable,y=value,group=subject_accession,color=responder0))+geom_line(aes(linetype=Age_cat))+geom_point()+xlab("Day (for Cell proportion)")+ylab("Cell proportion")+ggtitle("Cell Proportions across time points (Response based on Day 0)")+theme(text=element_text(size=10,family="Times"))

ggplot(na.omit(melt_data_sdy404),aes(x=variable,y=value,group=subject_accession,color=responder28))+geom_line(aes(linetype=Age_cat))+geom_point()+xlab("Day (for Cell proportion)")+ylab("Cell proportion")+ggtitle("Cell Proportions across time points (Response based on Day 28)")+theme(text=element_text(size=10,family="Times"))

ggplot(na.omit(melt_data_sdy404),aes(x=responder0,y=value, color=variable))+geom_boxplot()+xlab("Response at Day0")+ylab("Cell proportion")+ggtitle("Cell Proportions across time points for response at Day0")+facet_wrap(~Age_cat)+theme(text=element_text(size=10,family="Times"))

ggplot(na.omit(melt_data_sdy404),aes(x=responder28,y=value, color=variable))+geom_boxplot()+xlab("Response at Day28")+ylab("Cell proportion")+ggtitle("Cell Proportions across time points for response at Day28")+facet_wrap(~Age_cat)+theme(text=element_text(size=10,family="Times"))
```

```{r, include=FALSE, message=FALSE, warning=FALSE}
#p1<-ggscatter(data_sdy80,x=paste0("Day_-7"),y="FoldChange",add = "reg.line", conf.int = TRUE, 
 #           cor.coef = TRUE, cor.method = "pearson",xlab="Cell Proportion", ylab="Ab Titer Fold Change",title = "Tregs at Day -7")
  p2<-ggscatter(data_sdy404,x="Day_0",y="FoldChange",add = "reg.line", conf.int = TRUE, 
            cor.coef = TRUE, cor.method = "pearson",xlab="Cell Proportion", ylab="Ab Titer Fold Change",title = "Tregs at Day 0")+theme(text=element_text(size=10,family="Times"))

  p3<-ggscatter(data_sdy404,x="Day_2",y="FoldChange",add = "reg.line", conf.int = TRUE, 
            cor.coef = TRUE, cor.method = "pearson",xlab="Cell Proportion", ylab="Ab Titer Fold Change",title = "Tregs at Day 2")+theme(text=element_text(size=10,family="Times"))
  
  p4<-ggscatter(data_sdy404,x="Day_7",y="FoldChange",add = "reg.line", conf.int = TRUE, 
            cor.coef = TRUE, cor.method = "pearson",xlab="Cell Proportion", ylab="Ab Titer Fold Change",title = "Tregs at Day 7")+theme(text=element_text(size=10,family="Times"))
  
 p5<-ggscatter(data_sdy404,x="Day_28",y="FoldChange",add = "reg.line", conf.int = TRUE, 
            cor.coef = TRUE, cor.method = "pearson",xlab="Cell Proportion", ylab="Ab Titer Fold Change",title = "Tregs at Day 28")+theme(text=element_text(size=10,family="Times"))
``` 

```{r, warning=FALSE,echo=FALSE, results=TRUE}
 grid.arrange(p2,p3,p4,p5, ncol=2)
```

##SDY312
[SDY312](https://www.immport.org/shared/study/SDY312) - T cell responses to H1N1v and a longitudinal study of seasonal influenza vaccination (TIV) SLVP015 2009 (See companion studies SDY315 2012 / SDY314 2008 / SDY311 2010 / SDY112 2011). Related published articles can be found here - [1](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5358544/pdf/nihms846620.pdf), [2](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6686855/pdf/nihms-1044012.pdf), [3](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6803714/pdf/41597_2019_Article_213.pdf).

MetaData is extracted from the ImmPort data schema by querying the local database. First we build a local SQLite database instance and then query the database. The table below shows the filtered out data.
```{r, include=FALSE, message=FALSE, warning=FALSE}
sdy <- "SDY312"
##Set tab_dir to the folder where the study files are located
studies_dir <- file.path(paste0("./Spreadsheets/SDY312_Study"))
tab_dir <- file.path(studies_dir,"Tab")
list.files(tab_dir)

##Set db dir to the folder where the database file "ImmPort.sqlite" should be stored
db_dir <- file.path(studies_dir,"Db")

##Build a local SQLite ImmPort database instance
#buildNewSqliteDb(tab_dir, db_dir)  ##Already built
list.files(db_dir)

######
sqlite_conn <- dbConnect(SQLite(), dbname=file.path(db_dir, "ImmPort.sqlite"))
setImmPortDataSource(sqlite_conn)
getListOfStudies()
```

```{r, include=FALSE, message=FALSE, warning=FALSE}
fcs_meta_Data <- dbGetQuery(sqlite_conn,"SELECT a.name, a.file_info_id, b.expsample_accession, b.file_info_id,
                            c.biosample_accession, c.expsample_accession, 
                            d.biosample_accession, d.study_time_collected, d.subject_accession, d.type,
                            e.subject_accession, e.max_subject_age
                            FROM file_info a
                            INNER JOIN expsample_2_file_info b
                            ON a.file_info_id = b.file_info_id
                            INNER JOIN expsample_2_biosample c
                            ON c.expsample_accession = b.expsample_accession
                            INNER JOIN biosample d
                            ON d.biosample_accession = c.biosample_accession
                            INNER JOIN arm_2_subject e
                            ON e.subject_accession = d.subject_accession
                            AND a.name LIKE '%.fcs%'
                            AND a.name NOT LIKE '%Compensation%';")
```

```{r,echo=FALSE, results=TRUE}
kable(fcs_meta_Data)%>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "500px")
```

Antibody titer for SDY 312:
Responders vs Non-responders: titer >= 40 are responders and titer < 40 are non-responders at Visit 0. Fold change is calculated as $\frac{"Geometric mean of Ab titer of all strains on Day 28"}{Geometric mean of Ab titer of all strains on Day 0}$. 
```{r,include=FALSE, message=FALSE, warning=FALSE}
fcs_meta_Data <- unique(fcs_meta_Data[,-c(3,7)])

#This file has the list of fcs files we have
header_info <- read.xlsx("./Spreadsheets/Header_SDY312.xlsx",sheet=1) 
colnames(header_info)[1] <- "name"
mm_sdy312 <- merge(fcs_meta_Data, header_info, by="name")
final_tab_sdy312 <- mm_sdy312[which(mm_sdy312$Panel == "3"),]
#write.csv(final_tab[,-c(4,6,7,11,13,14,15)],"/Volumes/Samsung_T5/Immport_UH2/Companion_studies_1/SDY144/Analysis/MetaData_Tcells_SDY144.csv",row.names=FALSE)
#write.csv(final_tab[,-c(4,7,10,11)],"/Volumes/Samsung_T5/Immport_UH2/Companion_studies_1/SDY144/Analysis/MetaData_Tcells_SDY144.csv",row.names=FALSE)
```

```{r, include=FALSE, warning=FALSE, message=FALSE}
ab_titer_sdy312 <- read.delim("./Spreadsheets/SDY312_Study/Tab/SDY312-DR29_Tab/Tab/hai_result.txt",stringsAsFactors = FALSE,sep="\t",header=TRUE)
  #ab_titer <- ab_titer[which(ab_titer$STUDY_TIME_COLLECTED == '0'),]
ab_titer_d_sdy312 <- dcast(ab_titer_sdy312[,-c(1:9,11,13,14,15,17,19)],SUBJECT_ACCESSION+STUDY_TIME_COLLECTED~VIRUS_STRAIN_REPORTED,value.var='VALUE_REPORTED')
ab_titer_d_sdy312$Geometric_mean <- apply(ab_titer_d_sdy312[,3:9],1,function(x) geometric.mean(x,na.rm=TRUE))
resp_sdy312 <- dcast(ab_titer_d_sdy312,SUBJECT_ACCESSION~STUDY_TIME_COLLECTED,value.var='Geometric_mean')
resp_sdy312$FoldChange <- resp_sdy312$`28`/resp_sdy312$`0`
resp_sdy312$responder0 <- cut(resp_sdy312$`0`, breaks = c(0,40,max(resp_sdy312$`0`)), labels=c("NonResponder","Responder"))
resp_sdy312$responder28 <- cut(resp_sdy312$`28`, breaks = c(0,40,max(resp_sdy312$`28`)), labels=c("NonResponder","Responder"))
resp_sdy312$responderFC <- cut(resp_sdy312$FoldChange, breaks = c(0,4,max(resp_sdy312$FoldChange)), labels = c("NonResponder","Responder"))
resp_sdy312$responder_Day0_FC <- ifelse(resp_sdy312$responder0 == "Responder" | resp_sdy312$responderFC == "Responder","Responder","NonResponder")
colnames(resp_sdy312)[1] <- "subject_accession"
```

```{r,echo=FALSE, results=TRUE}
###Print the ab titer table
kable(resp_sdy312)%>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "500px")
```

Line Plots for ab-titer across the time points. Colors indicate responder or non-responder based on Day28 titer (> 40 is a responder)
```{r,echo=FALSE, results=TRUE}
melt_response_sdy312 <- melt(resp_sdy312[,c(1:3,5,6)],id=c("subject_accession","responder0","responder28"))
#ggplot(na.omit(melt_response_sdy312),aes(x=variable,y=value,group=subject_accession,color=responder0))+geom_line()
ggplot(na.omit(melt_response_sdy312),aes(x=variable,y=value,group=subject_accession,color=responder28))+geom_line()+geom_point()+xlab("Day")+ylab("titer")+ggtitle("Antibody response across time points")+theme(text=element_text(size=10,family="Times"))
```

Tregs population proportions: Plot below shows the proportions of Tregs. Colors indicate responder or non-responder based on ab-titer at Day 28. (> 40 is a responder)
```{r, include=FALSE, message=FALSE, warning=FALSE}
#Reading the population percentages
sdy312 <- read.xlsx("./Spreadsheets/SDY312_Tregs_proportions.xlsx",sheet=2)[,c(1:7)]
sdy312$Day <- paste0("Day_",sdy312$Day)
cast_sdy312 <- dcast(sdy312,subject_accession+Age+Study~Day,value.var='Tregs',fun.aggregate = mean)
#ggplot(sdy80,aes(x=Day,y=Tregs,group=subject_accession,color=subject_accession))+geom_line()
cast_sdy312 <- cast_sdy312[cast_sdy312$subject_accession %in% resp_sdy312$subject_accession,]
data_sdy312 <- left_join(cast_sdy312,resp_sdy312,by='subject_accession')
data_sdy312$Age_cat <- cut(data_sdy312$Age, breaks = c(0,60,120), labels = c("young","old"))
```

```{r,echo=FALSE, results=TRUE}
tab_sdy312 <- table(data_sdy312$Age_cat,data_sdy312$responder28)

kable(tab_sdy312) %>%
  kable_styling() %>%
  column_spec(c(1:2),border_right = TRUE, border_left = TRUE)

mlt_sdy312 <- melt(tab_sdy312)
ggplot(mlt_sdy312,aes(x=Var2,y=value,fill=factor(Var1)))+geom_bar(stat="identity",width = 0.3,alpha=0.6)+xlab("Response")+ylab("Number of subjects")+scale_fill_manual(values=c("deepskyblue4","brown3"),name="Age")+theme(text=element_text(size=10,family="Times"))

```

```{r,echo=FALSE, results=TRUE}
ggplot(na.omit(data_sdy312),aes(x=Age_cat,y=Day_0,color=responder28))+geom_boxplot()+xlab("Age")+ylab("Cell Proportion")+ggtitle("Boxplot of Cell Proportion at Day 0")+theme(text=element_text(size=10,family="Times"))
```


```{r, message=FALSE, warning=FALSE,echo=FALSE, results=TRUE}
#p1<-ggscatter(data_sdy80,x=paste0("Day_-7"),y="FoldChange",add = "reg.line", conf.int = TRUE, 
 #           cor.coef = TRUE, cor.method = "pearson",xlab="Cell Proportion", ylab="Ab Titer Fold Change",title = "Tregs at Day -7")
ggscatter(data_sdy312,x="Day_0",y="FoldChange",add = "reg.line", conf.int = TRUE, 
            cor.coef = TRUE, cor.method = "pearson",xlab="Cell Proportion", ylab="Ab Titer Fold Change",title = "Tregs at Day 0")+theme(text=element_text(size=10,family="Times"))
```


##SDY514
[SDY514](https://www.immport.org/shared/study/SDY514) - Monozygotic and Dizygotic Twin Pair T-Cell Responses to Influenza Vaccination SLVP018 2009. Related published articles can be found here - [1](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4302727/pdf/nihms651809.pdf), [2](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6803714/pdf/41597_2019_Article_213.pdf).

MetaData is extracted from the ImmPort data schema by querying the local database. First we build a local SQLite database instance and then query the database. The table below shows the filtered out data.
```{r, include=FALSE, message=FALSE, warning=FALSE}
sdy <- "SDY514"
##Set tab_dir to the folder where the study files are located
studies_dir <- file.path(paste0("./Spreadsheets/SDY514_Study"))
tab_dir <- file.path(studies_dir,"Tab")
list.files(tab_dir)

##Set db dir to the folder where the database file "ImmPort.sqlite" should be stored
db_dir <- file.path(studies_dir,"Db")

##Build a local SQLite ImmPort database instance
#buildNewSqliteDb(tab_dir, db_dir)  ##Already built
list.files(db_dir)

######
sqlite_conn <- dbConnect(SQLite(), dbname=file.path(db_dir, "ImmPort.sqlite"))
setImmPortDataSource(sqlite_conn)
getListOfStudies()
```

```{r, include=FALSE, message=FALSE, warning=FALSE}
fcs_meta_Data <- dbGetQuery(sqlite_conn,"SELECT a.name, a.file_info_id, b.expsample_accession, b.file_info_id,
                            c.biosample_accession, c.expsample_accession, 
                            d.biosample_accession, d.study_time_collected, d.subject_accession, d.type,
                            e.subject_accession, e.max_subject_age
                            FROM file_info a
                            INNER JOIN expsample_2_file_info b
                            ON a.file_info_id = b.file_info_id
                            INNER JOIN expsample_2_biosample c
                            ON c.expsample_accession = b.expsample_accession
                            INNER JOIN biosample d
                            ON d.biosample_accession = c.biosample_accession
                            INNER JOIN arm_2_subject e
                            ON e.subject_accession = d.subject_accession
                            AND a.name LIKE '%.fcs%'
                            AND a.name NOT LIKE '%Compensation%';")
```


```{r,echo=FALSE, results=TRUE}
kable(fcs_meta_Data)%>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "500px")
```

Antibody titer for SDY 514:
Responders vs Non-responders: titer >= 40 are responders and titer < 40 are non-responders at Visit 0. Fold change is calculated as $\frac{"Geometric mean of Ab titer of all strains on Day 28"}{Geometric mean of Ab titer of all strains on Day 0}$. 
```{r,include=FALSE, message=FALSE, warning=FALSE}
fcs_meta_Data <- unique(fcs_meta_Data[,-c(3,7)])

#This file has the list of fcs files we have
header_info <- read.xlsx("./Spreadsheets/Header_SDY514.xlsx",sheet=1) 
colnames(header_info)[1] <- "name"
mm_sdy514 <- merge(fcs_meta_Data, header_info, by="name")
final_tab_sdy514 <- mm_sdy514[which(mm_sdy514$Panel == "3"),]
#write.csv(final_tab[,-c(4,6,7,11,13,14,15)],"/Volumes/Samsung_T5/Immport_UH2/Companion_studies_1/SDY144/Analysis/MetaData_Tcells_SDY144.csv",row.names=FALSE)
#write.csv(final_tab[,-c(4,7,10,11)],"/Volumes/Samsung_T5/Immport_UH2/Companion_studies_1/SDY144/Analysis/MetaData_Tcells_SDY144.csv",row.names=FALSE)
```

```{r, include=FALSE, warning=FALSE, message=FALSE}
ab_titer_sdy514 <- read.delim("./Spreadsheets/SDY514_Study/Tab/SDY514-DR32_Tab/Tab/hai_result.txt",stringsAsFactors = FALSE,sep="\t",header=TRUE)
  #ab_titer <- ab_titer[which(ab_titer$STUDY_TIME_COLLECTED == '0'),]
ab_titer_d_sdy514 <- dcast(ab_titer_sdy514[,-c(1:9,11,13,14,15,17,19)],SUBJECT_ACCESSION+STUDY_TIME_COLLECTED~VIRUS_STRAIN_REPORTED,value.var='VALUE_REPORTED',fun.aggregate = geometric.mean)
ab_titer_d_sdy514$Geometric_mean <- apply(ab_titer_d_sdy514[,3:5],1,function(x) geometric.mean(x,na.rm=TRUE))
resp_sdy514 <- dcast(ab_titer_d_sdy514,SUBJECT_ACCESSION~STUDY_TIME_COLLECTED,value.var='Geometric_mean')
resp_sdy514$FoldChange <- resp_sdy514$`28`/resp_sdy514$`0`
resp_sdy514$responder0 <- cut(resp_sdy514$`0`, breaks = c(0,40,max(resp_sdy514$`0`)), labels=c("NonResponder","Responder"))
resp_sdy514$responder28 <- cut(resp_sdy514$`28`, breaks = c(0,40,max(resp_sdy514$`28`)), labels=c("NonResponder","Responder"))
resp_sdy514$responderFC <- cut(resp_sdy514$FoldChange, breaks = c(0,4,max(resp_sdy514$FoldChange)), labels = c("NonResponder","Responder"))
resp_sdy514$responder_Day0_FC <- ifelse(resp_sdy514$responder0 == "Responder" | resp_sdy514$responderFC == "Responder","Responder","NonResponder")
colnames(resp_sdy514)[1] <- "subject_accession"
```

```{r,echo=FALSE, results=TRUE}
###Print the ab titer table
kable(resp_sdy514)%>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "500px")
```

Line Plots for ab-titer across the time points. Colors indicate responder or non-responder based on Day28 titer (> 40 is a responder)
```{r,echo=FALSE, results=TRUE}
melt_response_sdy514 <- melt(resp_sdy514[,c(1:3,5,6)],id=c("subject_accession","responder0","responder28"))
#ggplot(na.omit(melt_response_sdy312),aes(x=variable,y=value,group=subject_accession,color=responder0))+geom_line()
ggplot(na.omit(melt_response_sdy514),aes(x=variable,y=value,group=subject_accession,color=responder28))+geom_line()+geom_point()+xlab("Day")+ylab("titer")+ggtitle("Antibody response across time points")+theme(text=element_text(size=10,family="Times"))
```

Tregs population proportions: Plot below shows the proportions of Tregs. Colors indicate responder or non-responder based on ab-titer at Day 28. (> 40 is a responder)
```{r, include=FALSE, message=FALSE, warning=FALSE}
#Reading the population percentages
sdy514 <- read.xlsx("./Spreadsheets/SDY514_Percentages.xlsx",sheet=3)[,c(1:7)]
sdy514$Day <- paste0("Day_",sdy514$Day)
cast_sdy514 <- dcast(sdy514,subject_accession+Age+Study~Day,value.var='Tregs',fun.aggregate = mean)
#ggplot(sdy80,aes(x=Day,y=Tregs,group=subject_accession,color=subject_accession))+geom_line()
cast_sdy514 <- cast_sdy514[cast_sdy514$subject_accession %in% resp_sdy514$subject_accession,]
data_sdy514 <- left_join(cast_sdy514,resp_sdy514,by='subject_accession')
data_sdy514$Age_cat <- cut(data_sdy514$Age, breaks = c(0,60,120), labels = c("young","old"))
```

```{r,echo=FALSE, results=TRUE}
tab_sdy514 <- table(data_sdy514$Age_cat,data_sdy514$responder28)

kable(tab_sdy514) %>%
  kable_styling() %>%
  column_spec(c(1:2),border_right = TRUE, border_left = TRUE)

mlt_sdy514 <- melt(tab_sdy514)
ggplot(mlt_sdy514,aes(x=Var2,y=value,fill=factor(Var1)))+geom_bar(stat="identity",width = 0.3,alpha=0.6)+xlab("Response")+ylab("Number of subjects")+scale_fill_manual(values=c("deepskyblue4","brown3"),name="Age")+theme(text=element_text(size=10,family="Times"))

```

```{r,echo=FALSE, results=TRUE}
ggplot(na.omit(data_sdy514),aes(x=Age_cat,y=Day_0,color=responder28))+geom_boxplot()+xlab("Age")+ylab("Cell Proportion")+ggtitle("Boxplot of Cell Proportion at Day 0")+theme(text=element_text(size=10,family="Times"))
```


```{r, include=TRUE, message=FALSE, warning=FALSE}
#p1<-ggscatter(data_sdy80,x=paste0("Day_-7"),y="FoldChange",add = "reg.line", conf.int = TRUE, 
 #           cor.coef = TRUE, cor.method = "pearson",xlab="Cell Proportion", ylab="Ab Titer Fold Change",title = "Tregs at Day -7")
ggscatter(data_sdy514,x="Day_0",y="FoldChange",add = "reg.line", conf.int = TRUE, 
            cor.coef = TRUE, cor.method = "pearson",xlab="Cell Proportion", ylab="Ab Titer Fold Change",title = "Tregs at Day 0")+theme(text=element_text(size=10,family="Times"))+theme(text=element_text(size=10,family="Times"))
```



##SDY202
[SDY202](https://www.immport.org/shared/study/SDY202) - Heterovariant cross-reactive B-cell responses induced by the 2009 pandemic influenza virus A subtype H1N1 vaccine SLVP021. Related published articles can be found [here](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3532823/pdf/jis664.pdf).

MetaData is extracted from the ImmPort data schema by querying the local database. First we build a local SQLite database instance and then query the database. The table below shows the filtered out data.
```{r, include=FALSE, message=FALSE, warning=FALSE}
sdy <- "SDY202"
##Set tab_dir to the folder where the study files are located
studies_dir <- file.path(paste0("./Spreadsheets/SDY202_Study"))
tab_dir <- file.path(studies_dir,"Tab")
list.files(tab_dir)

##Set db dir to the folder where the database file "ImmPort.sqlite" should be stored
db_dir <- file.path(studies_dir,"Db")

##Build a local SQLite ImmPort database instance
#buildNewSqliteDb(tab_dir, db_dir)  ##Already built
list.files(db_dir)

######
sqlite_conn <- dbConnect(SQLite(), dbname=file.path(db_dir, "ImmPort.sqlite"))
setImmPortDataSource(sqlite_conn)
getListOfStudies()
```

```{r, include=FALSE, message=FALSE, warning=FALSE}
fcs_meta_Data <- dbGetQuery(sqlite_conn,"SELECT a.name, a.file_info_id, b.expsample_accession, b.file_info_id,
                            c.biosample_accession, c.expsample_accession, 
                            d.biosample_accession, d.study_time_collected, d.subject_accession, d.type,
                            e.subject_accession, e.max_subject_age
                            FROM file_info a
                            INNER JOIN expsample_2_file_info b
                            ON a.file_info_id = b.file_info_id
                            INNER JOIN expsample_2_biosample c
                            ON c.expsample_accession = b.expsample_accession
                            INNER JOIN biosample d
                            ON d.biosample_accession = c.biosample_accession
                            INNER JOIN arm_2_subject e
                            ON e.subject_accession = d.subject_accession
                            AND a.name LIKE '%.fcs%'
                            AND a.name NOT LIKE '%Compensation%';")
```

```{r,echo=FALSE, results=TRUE}
kable(fcs_meta_Data)%>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "500px")
```

Antibody titer for SDY 202:
Responders vs Non-responders: titer >= 40 are responders and titer < 40 are non-responders at Visit 0. Fold change is calculated as $\frac{"Geometric mean of Ab titer of all strains on Day 28"}{Geometric mean of Ab titer of all strains on Day 0}$. 
```{r,include=FALSE, message=FALSE, warning=FALSE}
fcs_meta_Data <- unique(fcs_meta_Data[,-c(3,7)])
#This file has the list of fcs files we have
header_info <- read.xlsx("./Spreadsheets/Header_SDY202.xlsx",sheet=1) 
colnames(header_info)[1] <- "name"
mm_sdy202 <- merge(fcs_meta_Data, header_info, by="name")
final_tab_sdy202 <- mm_sdy202[which(mm_sdy202$Panel == "3"),]
#write.csv(final_tab[,-c(4,6,7,11,13,14,15)],"/Volumes/Samsung_T5/Immport_UH2/Companion_studies_1/SDY144/Analysis/MetaData_Tcells_SDY144.csv",row.names=FALSE)
#write.csv(final_tab[,-c(4,7,10,11)],"/Volumes/Samsung_T5/Immport_UH2/Companion_studies_1/SDY144/Analysis/MetaData_Tcells_SDY144.csv",row.names=FALSE)
```

```{r, include=FALSE, warning=FALSE, message=FALSE}
ab_titer_sdy202 <- read.delim("./Spreadsheets/SDY202_Study/Tab/SDY202-DR29_Tab/Tab/hai_result.txt",stringsAsFactors = FALSE,sep="\t",header=TRUE)
  #ab_titer <- ab_titer[which(ab_titer$STUDY_TIME_COLLECTED == '0'),]
ab_titer_d_sdy202 <- dcast(ab_titer_sdy202[,-c(1:9,11,13,14,15,18,19)],SUBJECT_ACCESSION+STUDY_TIME_COLLECTED~VIRUS_STRAIN_PREFERRED,value.var='VALUE_REPORTED',fun.aggregate = geometric.mean)
#ab_titer_d_sdy202$Geometric_mean <- apply(ab_titer_d_sdy202[,3],1,function(x) geometric.mean(x,na.rm=TRUE))
resp_sdy202 <- dcast(ab_titer_d_sdy202,SUBJECT_ACCESSION~STUDY_TIME_COLLECTED,value.var='A/Brisbane/59/2007')
resp_sdy202$FoldChange <- resp_sdy202$`28`/resp_sdy202$`0`
resp_sdy202$responder0 <- cut(resp_sdy202$`0`, breaks = c(0,40,max(resp_sdy202$`0`)), labels=c("NonResponder","Responder"))
resp_sdy202$responder28 <- cut(resp_sdy202$`28`, breaks = c(0,40,max(resp_sdy202$`28`)), labels=c("NonResponder","Responder"))
resp_sdy202$responderFC <- cut(resp_sdy202$FoldChange, breaks = c(0,4,max(resp_sdy202$FoldChange)), labels = c("NonResponder","Responder"))
resp_sdy202$responder_Day0_FC <- ifelse(resp_sdy202$responder0 == "Responder" | resp_sdy202$responderFC == "Responder","Responder","NonResponder")
colnames(resp_sdy202)[1] <- "subject_accession"
```

```{r,echo=FALSE, results=TRUE}
###Print the ab titer table
kable(resp_sdy202)%>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "500px")
```

Line Plots for ab-titer across the time points. Colors indicate responder or non-responder based on Day28 titer (> 40 is a responder)
```{r,echo=FALSE, results=TRUE}
melt_response_sdy202 <- melt(resp_sdy202[,c(1:3,5,6)],id=c("subject_accession","responder0","responder28"))
#ggplot(na.omit(melt_response_sdy312),aes(x=variable,y=value,group=subject_accession,color=responder0))+geom_line()
ggplot(na.omit(melt_response_sdy202),aes(x=variable,y=value,group=subject_accession,color=responder28))+geom_line()+geom_point()+xlab("Day")+ylab("titer")+ggtitle("Antibody response across time points")+theme(text=element_text(size=10,family="Times"))
```

Tregs population proportions: Plot below shows the proportions of Tregs. Colors indicate responder or non-responder based on ab-titer at Day 28. (> 40 is a responder)
```{r, include=FALSE, message=FALSE, warning=FALSE}
#Reading the population percentages
sdy202 <- read.xlsx("./Spreadsheets/SDY202_percentages.xlsx",sheet=2)[,c(1:7)]
sdy202$Day <- paste0("Day_",sdy202$Day)
cast_sdy202 <- dcast(na.omit(sdy202),subject_accession+Age+Study~Day,value.var='Tregs',fun.aggregate = mean)
#ggplot(sdy80,aes(x=Day,y=Tregs,group=subject_accession,color=subject_accession))+geom_line()
cast_sdy202 <- cast_sdy202[cast_sdy202$subject_accession %in% resp_sdy202$subject_accession,]
data_sdy202 <- left_join(cast_sdy202,resp_sdy202,by='subject_accession')
data_sdy202$Age_cat <- cut(data_sdy202$Age, breaks = c(0,60,120), labels = c("young","old"))
```

```{r,echo=FALSE, results=TRUE}
tab_sdy202 <- table(data_sdy202$Age_cat,data_sdy202$responder28)

kable(tab_sdy202) %>%
  kable_styling() %>%
  column_spec(c(1:2),border_right = TRUE, border_left = TRUE)

mlt_sdy202 <- melt(tab_sdy202)
ggplot(mlt_sdy202,aes(x=Var2,y=value,fill=factor(Var1)))+geom_bar(stat="identity",width = 0.3,alpha=0.6)+xlab("Response")+ylab("Number of subjects")+scale_fill_manual(values=c("deepskyblue4","brown3"),name="Age")+theme(text=element_text(size=10,family="Times"))

```

```{r,echo=FALSE, results=TRUE}
ggplot(na.omit(data_sdy202),aes(x=Age_cat,y=Day_0,color=responder28))+geom_boxplot()+xlab("Age")+ylab("Cell Proportion")+ggtitle("Boxplot of Cell Proportion at Day 0")+theme(text=element_text(size=10,family="Times"))
```


```{r, echo=FALSE, results=TRUE, message=FALSE, warning=FALSE}
#p1<-ggscatter(data_sdy80,x=paste0("Day_-7"),y="FoldChange",add = "reg.line", conf.int = TRUE, 
 #           cor.coef = TRUE, cor.method = "pearson",xlab="Cell Proportion", ylab="Ab Titer Fold Change",title = "Tregs at Day -7")
ggscatter(data_sdy202,x="Day_0",y="FoldChange",add = "reg.line", conf.int = TRUE, 
            cor.coef = TRUE, cor.method = "pearson",xlab="Cell Proportion", ylab="Ab Titer Fold Change",title = "Tregs at Day 0")+theme(text=element_text(size=10,family="Times"))+theme(text=element_text(size=10,family="Times"))
```

##SDY739
[SDY739](https://www.immport.org/shared/study/SDY739) - Humoral responses to Influenza vaccination in aged populations - Year 4 2014 (See companion studies SDY272 2011, SDY622 2012, SDY648 2013, SDY819 2015). Related published articles can be found [1](https://www.aging-us.com/article/100541/text), [2](https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0077164), [3](https://www.jimmunol.org/content/193/7/3528.long), [4](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4637297/pdf/oncotarget-06-19445.pdf), [5](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4712333/pdf/aging-07-1077.pdf)

MetaData is extracted from the ImmPort data schema by querying the local database. First we build a local SQLite database instance and then query the database. The table below shows the filtered out data.
```{r, include=FALSE, message=FALSE, warning=FALSE}
sdy <- "SDY739"
##Set tab_dir to the folder where the study files are located
studies_dir <- file.path(paste0("./Spreadsheets/SDY739_Study"))
tab_dir <- file.path(studies_dir,"Tab")
list.files(tab_dir)

##Set db dir to the folder where the database file "ImmPort.sqlite" should be stored
db_dir <- file.path(studies_dir,"Db")

##Build a local SQLite ImmPort database instance
#buildNewSqliteDb(tab_dir, db_dir)  ##Already built
list.files(db_dir)

######
sqlite_conn <- dbConnect(SQLite(), dbname=file.path(db_dir, "ImmPort.sqlite"))
setImmPortDataSource(sqlite_conn)
getListOfStudies()
```

```{r, include=FALSE, message=FALSE, warning=FALSE}
fcs_meta_Data <- dbGetQuery(sqlite_conn,"SELECT a.name, a.file_info_id, b.expsample_accession, b.file_info_id,
                            c.biosample_accession, c.expsample_accession, 
                            d.biosample_accession, d.study_time_collected, d.subject_accession, d.type,
                            e.subject_accession, e.max_subject_age
                            FROM file_info a
                            INNER JOIN expsample_2_file_info b
                            ON a.file_info_id = b.file_info_id
                            INNER JOIN expsample_2_biosample c
                            ON c.expsample_accession = b.expsample_accession
                            INNER JOIN biosample d
                            ON d.biosample_accession = c.biosample_accession
                            INNER JOIN arm_2_subject e
                            ON e.subject_accession = d.subject_accession
                            AND a.name LIKE '%.fcs%'
                            AND a.name NOT LIKE '%Compensation%';")
```

```{r,echo=FALSE, results=TRUE}
kable(fcs_meta_Data)%>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "500px")
```

Antibody titer for SDY 202:
Responders vs Non-responders: titer >= 40 are responders and titer < 40 are non-responders at Visit 0. Fold change is calculated as $\frac{"Geometric mean of Ab titer of all strains on Day 28"}{Geometric mean of Ab titer of all strains on Day 0}$. 
```{r,include=FALSE, message=FALSE, warning=FALSE}
fcs_meta_Data <- unique(fcs_meta_Data[,-c(3,7)])

#This file has the list of fcs files we have
header_info <- read.xlsx("./Spreadsheets/Header_SDY739.xlsx",sheet=1) 
colnames(header_info)[1] <- "name"
mm_sdy739 <- merge(fcs_meta_Data, header_info, by="name")
final_tab_sdy739 <- mm_sdy739[which(mm_sdy739$Panel == "2"),]
#write.csv(final_tab[,-c(4,6,7,11,13,14,15)],"/Volumes/Samsung_T5/Immport_UH2/Companion_studies_1/SDY144/Analysis/MetaData_Tcells_SDY144.csv",row.names=FALSE)
#write.csv(final_tab[,-c(4,7,10,11)],"/Volumes/Samsung_T5/Immport_UH2/Companion_studies_1/SDY144/Analysis/MetaData_Tcells_SDY144.csv",row.names=FALSE)
```

```{r, include=FALSE, warning=FALSE, message=FALSE}
ab_titer_sdy739 <- read.delim("./Spreadsheets/SDY739_Study/Tab/SDY739-DR32_Tab/Tab/neut_ab_titer_result.txt",stringsAsFactors = FALSE,sep="\t",header=TRUE)
  #ab_titer <- ab_titer[which(ab_titer$STUDY_TIME_COLLECTED == '0'),]
ab_titer_d_sdy739 <- dcast(ab_titer_sdy739[,-c(1:9,11,13,14,15,17,19)],SUBJECT_ACCESSION+STUDY_TIME_COLLECTED~VIRUS_STRAIN_REPORTED,value.var='VALUE_REPORTED',fun.aggregate = geometric.mean)
ab_titer_d_sdy739$Geometric_mean <- apply(ab_titer_d_sdy739[,3:4],1,function(x) geometric.mean(x,na.rm=TRUE))
resp_sdy739 <- dcast(ab_titer_d_sdy739,SUBJECT_ACCESSION~STUDY_TIME_COLLECTED,value.var='Geometric_mean')
resp_sdy739$FoldChange <- resp_sdy739$`28`/(resp_sdy739$`0`+0.00001)
resp_sdy739$responder0 <- cut(resp_sdy739$`0`, breaks = c(0,40,max(resp_sdy739$`0`)), labels=c("NonResponder","Responder"))
resp_sdy739$responder28 <- cut(resp_sdy739$`28`, breaks = c(-1,40,max(resp_sdy739$`28`)), labels=c("NonResponder","Responder"))
resp_sdy739$responderFC <- cut(resp_sdy739$FoldChange, breaks = c(0,4,max(NaRV.omit(resp_sdy739$FoldChange))), labels = c("NonResponder","Responder"))
resp_sdy739$responder_Day0_FC <- ifelse(resp_sdy739$responder0 == "Responder" | resp_sdy739$responderFC == "Responder","Responder","NonResponder")
colnames(resp_sdy739)[1] <- "subject_accession"
```

```{r,echo=FALSE, results=TRUE}
###Print the ab titer table
kable(resp_sdy739)%>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "500px")
```

Line Plots for ab-titer across the time points. Colors indicate responder or non-responder based on Day28 titer (> 40 is a responder)
```{r,echo=FALSE, results=TRUE}
melt_response_sdy739 <- melt(resp_sdy739[,c(1:4,6,7)],id=c("subject_accession","responder0","responder28"))
#ggplot(na.omit(melt_response_sdy312),aes(x=variable,y=value,group=subject_accession,color=responder0))+geom_line()
ggplot(na.omit(melt_response_sdy739),aes(x=variable,y=value,group=subject_accession,color=responder28))+geom_line()+geom_point()+xlab("Day")+ylab("titer")+ggtitle("Antibody response across time points")+theme(text=element_text(size=10,family="Times"))
```

Tregs population proportions: Plot below shows the proportions of Tregs. Colors indicate responder or non-responder based on ab-titer at Day 28. (> 40 is a responder)
```{r, include=FALSE, message=FALSE, warning=FALSE}
#Reading the population percentages
sdy739 <- read.xlsx("./Spreadsheets/SDY739_Percentages.xlsx",sheet=3)[,c(1:7)]
sdy739$Day <- paste0("Day_",sdy739$Day)
cast_sdy739 <- dcast(na.omit(sdy739),subject_accession+Age+Study~Day,value.var='Tregs',fun.aggregate = mean)
#ggplot(sdy80,aes(x=Day,y=Tregs,group=subject_accession,color=subject_accession))+geom_line()
cast_sdy739 <- cast_sdy739[cast_sdy739$subject_accession %in% resp_sdy739$subject_accession,]
data_sdy739 <- left_join(cast_sdy739,resp_sdy739,by='subject_accession')
data_sdy739$Age_cat <- cut(data_sdy739$Age, breaks = c(0,60,120), labels = c("young","old"))
```

```{r,echo=FALSE, results=TRUE}
tab_sdy739 <- table(data_sdy739$Age_cat,data_sdy739$responder28)

kable(tab_sdy739) %>%
  kable_styling() %>%
  column_spec(c(1:2),border_right = TRUE, border_left = TRUE)

mlt_sdy739 <- melt(tab_sdy739)
ggplot(mlt_sdy739,aes(x=Var2,y=value,fill=factor(Var1)))+geom_bar(stat="identity",width = 0.3,alpha=0.6)+xlab("Response")+ylab("Number of subjects")+scale_fill_manual(values=c("deepskyblue4","brown3"),name="Age")+theme(text=element_text(size=10,family="Times"))

```

```{r,echo=FALSE, results=TRUE}
ggplot(data_sdy739,aes(x=Age_cat,y=Day_0,color=responder28))+geom_boxplot()+xlab("Age")+ylab("Cell Proportion")+ggtitle("Boxplot of Cell Proportion at Day 0")+theme(text=element_text(size=10,family="Times"))
```


```{r, echo=FALSE, results=TRUE, message=FALSE, warning=FALSE}
#p1<-ggscatter(data_sdy80,x=paste0("Day_-7"),y="FoldChange",add = "reg.line", conf.int = TRUE, 
 #           cor.coef = TRUE, cor.method = "pearson",xlab="Cell Proportion", ylab="Ab Titer Fold Change",title = "Tregs at Day -7")
ggscatter(data_sdy739,x="Day_0",y="FoldChange",add = "reg.line", conf.int = TRUE, 
            cor.coef = TRUE, cor.method = "pearson",xlab="Cell Proportion", ylab="Ab Titer Fold Change",title = "Tregs at Day 0")+theme(text=element_text(size=10,family="Times"))
```


##Correlations
Table shows pearson correlations calculated across all the studies
```{r, include=FALSE}
corr_all <- data.frame(Study = c(rep("SDY67",4),rep("SDY80",4),rep("SDY404",4),rep("SDY312",1),rep("SDY514",1),rep("SDY202",1),rep("SDY739",1)),Visit=c(c("Day0","Day3","Day28","Day75"),c("Day0","Day1","Day7","Day70"),c("Day0","Day2","Day7","Day28"),rep(c("Day0"),4)),Tregs=c("-0.14","-0.18","-0.18","-0.13","0.51","0.12","0.032","0.072","0.011","-0.006","0.041","-0.034","-0.019","0.032","-0.047","-0.021"))
```

```{r, message=FALSE,echo=FALSE, results=TRUE}
kable(corr_all, align = "c") %>%
  kable_styling(c("bordered"),full_width = F) %>%
  column_spec(1, bold = T) %>%
  collapse_rows(columns = 1:2, valign = "top")
```