---
title: "FlowCytometry"
---


##Background

```{r, include=FALSE,message=FALSE}
library(ggplot2)
library(reshape2)
library(dplyr)
library(RImmPort)
library(DBI)
library(plyr)
library(RSQLite)
library(openxlsx)
library(kableExtra)
library(knitr)
library(shiny)
library(psych)
library(gridExtra)
library(ggpubr)
library(lme4)
library(IDPmisc)
library(stringr)
library(viridis)
```

SDY144, SDY364, SDY368, SDY387 and SDY404 have memory CD4+ and CD8+ markers. These studies were used for the analysis from [ImmPort database](https://www.immport.org/shared/home).

[1](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5192353/pdf/vaccines-04-00033.pdf), [2](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4339101/pdf/nihms660580.pdf) related papers on Memory T cell response to influenza vaccine.
```{r, include=FALSE}
cell_summ <- data.frame(CellPopulation = c("CD4+ T cells", "CD4+ Naive T cells","CD4+ Central Memory T cells", "CD4+ Effectory Memory T cells","CD4+ Temra cells","CD8+ T cells", "CD8+ Naive T cells","CD8+ Central Memory T cells", "CD8+ Effectory Memory T cells","CD8+ Temra cells"), CellDefinition=c("CD3+ CD4+ CD8-","CD3+ CD4+ CD8- CD45RA+ CCR7+","CD3+ CD4+ CD8- CD45RA- CCR7+","CD3+ CD4+ CD8- CD45RA- CCR7-","CD3+ CD4+ CD8- CD45RA+ CCR7-","CD3+ CD4- CD8+","CD3+ CD4- CD8+ CD45RA+ CCR7+","CD3+ CD4- CD8+ CD45RA- CCR7+","CD3+ CD4- CD8+ CD45RA- CCR7-","CD3+ CD4- CD8+ CD45RA+ CCR7-"))
```

```{r}
kable(cell_summ) %>%
  kable_styling(full_width = F,c("striped","bordered")) %>%
  row_spec(1:10,hline_after = TRUE) %>%
  column_spec(1:ncol(cell_summ),border_left = T, border_right = T)
```

```{r, include=FALSE}
summary_table <- data.frame(
  Studies=c("SDY144","SDY364","SDY368","SDY387","SDY404"),
  TimePoints=c("Day0, Day1, Day7, Day28","Day0, Day1, Day7, Day28", "Day0, Day1, Day7, Day28","Day0, Day7, Day28, Day90, Day180","Day0, Day2, Day3, Day4, Day7, Day17, Day21, Day24, Day28, Day35"),
  NumberOfSubjects=c("16","23","22","20","53"),
Neutralization=c("Yes (for Day 0 and Day 30)","Yes (for Day0 and Day 28)","Yes (for Day0 and Day 28)","Yes (for Day0 and Day 28)","No"),
  HAI=c("No","No","No","No","Yes (for Day0, Day 28 and Day 35)"),
GeneExpressionData = c("Yes (MA)", "Yes (MA)", "Yes (MA)", "Yes (MA)", "No")
)
```


```{r}
kable(summary_table) %>%
  kable_styling(full_width = F,c("striped","bordered")) %>%
  row_spec(1:5,hline_after = TRUE) %>%
  column_spec(1:ncol(summary_table),border_left = T, border_right = T)
```


##SDY144
[SDY144](https://www.immport.org/shared/study/SDY144) - Systems Biology Approach to Study Influenza Vaccine 2011-12 in Healthy Children (see companion studies SDY364, SDY368, SDY387). Related published article can be accessed [here](https://academic.oup.com/jid/article/210/2/224/2908549).
All the subjects are from younger cohort.

###MetaData
MetaData is extracted from the ImmPort data schema by querying the local database. First we build a local SQLite database instance and then query the database. The table below shows the filtered out data. To retrieve this meta data, file_info, expsample_2_file_info,  expsample_2_biosample, biosample, arm_2_subject and subject tables were queried from the database.
```{r, include=FALSE}
sdy <- "SDY144"

##Set tab_dir to the folder where the study files are located
studies_dir <- file.path(paste0("/Volumes/Samsung_T5/Immport_UH2/Companion_studies_1/"),sdy,"/Study")
tab_dir <- file.path(studies_dir,"Tab")
list.files(tab_dir)

##Set db dir to the folder where the database file "ImmPort.sqlite" should be stored
db_dir <- file.path(studies_dir,"Db")

##Build a local SQLite ImmPort database instance
#buildNewSqliteDb(tab_dir, db_dir)
list.files(db_dir)

sqlite_conn <- dbConnect(SQLite(), dbname=file.path(db_dir, "ImmPort.sqlite"))
setImmPortDataSource(sqlite_conn)
getListOfStudies()
```

```{r, include=FALSE, message=FALSE, warning=FALSE}
fcs_meta_Data <- dbGetQuery(sqlite_conn,"SELECT a.name, a.file_info_id, b.expsample_accession, b.file_info_id,
                            c.biosample_accession, c.expsample_accession, 
                            d.biosample_accession, d.study_time_collected, d.subject_accession, d.type,
                            e.subject_accession, e.max_subject_age,  f.ethnicity, f.race, f.description
                            FROM file_info a
                            INNER JOIN expsample_2_file_info b
                            ON a.file_info_id = b.file_info_id
                            INNER JOIN expsample_2_biosample c
                            ON c.expsample_accession = b.expsample_accession
                            INNER JOIN biosample d
                            ON d.biosample_accession = c.biosample_accession
                            INNER JOIN arm_2_subject e
                            ON e.subject_accession = d.subject_accession
                            INNER JOIN subject f
                            ON f.subject_accession = e.subject_accession
                            AND a.name LIKE '%.fcs%'
                            AND a.name NOT LIKE '%Compensation%';")
```

```{r}
kable(fcs_meta_Data)%>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "300px")
```

```{r, include=FALSE}
fcs_meta_Data <- unique(fcs_meta_Data[,-c(2,3,6,7)])
header_info <- read.xlsx("/Volumes/Samsung_T5/Immport_UH2/Companion_studies_1/SDY144/Analysis/Header_SDY144.xlsx",sheet=1)[,-4]                            
#colnames(header_info)[1] <- "name" 
mm_sdy144 <- merge(fcs_meta_Data, header_info, by="name")
final_tab_sdy144 <- mm_sdy144[which(mm_sdy144$Panel == "NCH_2011_FLOW_Tfh"),]
```

All the files from SDY144 T-cell panel were used in the analysis. Table below shows subjects' data used in the analysis and the number of files in each visit. 0 represents missing data for that subject and visit
```{r,warning=FALSE,message=FALSE}
kable(dcast(final_tab_sdy144[,c(1,4,5)],subject_accession~study_time_collected))%>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "300px")
```

Data Description: 
There are 64 files from 17 subjects. Below is the data summary for the files, showing the number of files for each covariate.
```{r, message=FALSE}
lapply(final_tab_sdy144[,-c(1,2,3,6,7,11,12,13,14)],table)
```

###Ab titer
Antibody titer for SDY144: Responders vs Non-responders: titer >= 40 are responders and titer < 40 are non-responders at Day 30. Fold change is calculated as $\frac{Geometric mean of Ab titer of all strains on Day 30}{Geometric mean of Ab titer of all strains on Day 0}$.
```{r, include=FALSE}
ab_titer_sdy144 <- read.table("/Volumes/Samsung_T5/Immport_UH2/Companion_studies_1/SDY144/Study/Tab/SDY144-DR28_Tab/Tab/hai_result.txt",sep = "\t", header=TRUE)
ab_titer_d_sdy144 <- dcast(ab_titer_sdy144,SUBJECT_ACCESSION+STUDY_TIME_COLLECTED~VIRUS_STRAIN_REPORTED,value.var='VALUE_REPORTED')
ab_titer_d_sdy144$Geometric_mean <- apply(ab_titer_d_sdy144[,3:5],1,function(x) geometric.mean(x,na.rm=TRUE))
resp_sdy144 <- dcast(ab_titer_d_sdy144,SUBJECT_ACCESSION~STUDY_TIME_COLLECTED,value.var='Geometric_mean')
resp_sdy144$FoldChange <- resp_sdy144$`30`/(resp_sdy144$`0`+0.00001)
resp_sdy144$responder0 <- cut(resp_sdy144$`0`, breaks = c(0,40,max(na.omit(resp_sdy144$`0`))), labels=c("NonResponder","Responder"))
resp_sdy144$responder30 <- cut(resp_sdy144$`30`, breaks = c(0,40,max(na.omit(resp_sdy144$`30`))), labels=c("NonResponder","Responder"))
resp_sdy144$responderFC <- cut(resp_sdy144$FoldChange, breaks = c(0,4,max(na.omit(resp_sdy144$FoldChange))), labels = c("NonResponder","Responder"))
resp_sdy144$responder_Day0_FC <- ifelse(resp_sdy144$responder0 == "Responder" | resp_sdy144$responderFC == "Responder","Responder","NonResponder")
colnames(resp_sdy144)[1] <- "subject_accession"
```

```{r}
###Print the ab titer table
kable(resp_sdy144)%>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "300px")
```

Line Plots for ab-titer across the time points. Colors indicate responder or non-responder based on Day30 titer (> 40 is a responder)
```{r}
melt_response <- melt(resp_sdy144[,c(1:3,6)],id=c("subject_accession","responder30"))
ggplot(na.omit(melt_response),aes(x=variable,y=value,group=subject_accession,color=responder30))+geom_line()+geom_point()+xlab("Day")+ylab("titer")+ggtitle("Antibody response across time points")+theme(text=element_text(size=10,  family="Times"))
```

###Flow Data Analysis
Configuration used in DAFi analysis
```{r comment=''}
#kable(as.matrix(read.table('inclusion_SDY144.config'), sep = '\t', header=TRUE))
```
Gating co-ordinates for SDY144
![alt text](/Volumes/Samsung_T5/Immport_UH2/Results_Analysis/MemoryCD4_CD8/SDY144_config.png)

Gating hierarchy used to identify the cell populations (example: SUB118176 at Day 28)
![alt text](/Volumes/Samsung_T5/Immport_UH2/Results_Analysis/MemoryCD4_CD8/SDY144_1.png)
![alt text](/Volumes/Samsung_T5/Immport_UH2/Results_Analysis/MemoryCD4_CD8/SDY144_2.png)
![alt text](/Volumes/Samsung_T5/Immport_UH2/Results_Analysis/MemoryCD4_CD8/SDY144_3.png)
![alt text](/Volumes/Samsung_T5/Immport_UH2/Results_Analysis/MemoryCD4_CD8/SDY144_4.png)

### Cell Proportions
```{r, include=FALSE}
#####Read the files########
sdy144 <- read.xlsx("/Volumes/Samsung_T5/Immport_UH2/Results_Analysis/MemoryCD4_CD8/SDY144_MemoryTcells.xlsx",sheet=2)[,-1]
sdy144$study_time_collected <- paste0("Day_",sdy144$study_time_collected)
melt_sdy144 <- melt(sdy144,id=c("name","study_time_collected","subject_accession","max_subject_age","Study"))
colnames(melt_sdy144)[6:7] <- c("CellType","CellProportion")
cast_sdy144 <- dcast(melt_sdy144,subject_accession+max_subject_age+CellType+Study~study_time_collected,value.var='CellProportion',fun.aggregate = mean)
cast_sdy144 <- cast_sdy144[which(cast_sdy144$subject_accession!="SUB118169"),]
colnames(resp_sdy144)[1] <- "subject_accession"
data_sdy144 <- left_join(cast_sdy144, resp_sdy144, by='subject_accession')
data_sdy144$Age_cat <- cut(data_sdy144$max_subject_age, breaks = c(0,60,120), labels = c("young","old"))
melt_data_sdy144 <- melt(data_sdy144[,-c(12,14,15)],id=c("subject_accession","max_subject_age","CellType","Study","0","30","FoldChange","responder30","Age_cat"))
```

```{r, warning=FALSE, message=FALSE}
for(i in 1:length(unique(data_sdy144$CellType))){
  data <- data_sdy144[data_sdy144$CellType == unique(data_sdy144$CellType)[i],]
  #data$variable <- factor(data$variable,levels = c("Day_0","Day_1","Day_7","Day_28"))
  data_m <- melt_data_sdy144[melt_data_sdy144$CellType == unique(data_sdy144$CellType)[i],]
  data_m$variable <- factor(data_m$variable,levels = c("Day_0","Day_1","Day_7","Day_28"))

p <- ggplot(na.omit(data_m),aes(x=variable,y=value, group=subject_accession, color=responder30))+geom_line()+geom_point()+ggtitle(paste0("Cell Proportions across visits for ",unique(data_sdy144$CellType)[i]))+xlab("Visit")+ylab("Cell Proportion")+theme(text=element_text(size=10,  family="Times"))

print(p)

  p1<-ggscatter(data,x="Day_0",y="FoldChange",add = "reg.line", conf.int = TRUE, 
            cor.coef = TRUE, cor.method = "pearson",xlab="Cell Proportion", ylab="Ab Titer Fold Change",title = paste0(unique(data_sdy144$CellType)[i]," at Day 0"))+font("title",size=11)+theme(text=element_text(size=10,  family="Times"))
  
  p2<-ggscatter(data,x="Day_1",y="FoldChange",add = "reg.line", conf.int = TRUE, 
            cor.coef = TRUE, cor.method = "pearson",xlab="Cell Proportion", ylab="Ab Titer Fold Change",title = paste0(unique(data_sdy144$CellType)[i]," at Day 1"))+font("title",size=11)+theme(text=element_text(size=10,  family="Times"))
  
  p3<-ggscatter(data,x="Day_7",y="FoldChange",add = "reg.line", conf.int = TRUE, 
            cor.coef = TRUE, cor.method = "pearson",xlab="Cell Proportion", ylab="Ab Titer Fold Change",title = paste0(unique(data_sdy144$CellType)[i]," at Day 7"))+font("title",size=11)+theme(text=element_text(size=10,  family="Times"))
  
  p4<-ggscatter(data,x="Day_28",y="FoldChange",add = "reg.line", conf.int = TRUE, 
            cor.coef = TRUE, cor.method = "pearson",xlab="Cell Proportion", ylab="Ab Titer Fold Change",title = paste0(unique(data_sdy144$CellType)[i]," at Day 28"))+font("title",size=11)+theme(text=element_text(size=10,  family="Times"))
  
  grid.arrange(p1,p2,p3,p4, ncol=2)
  }
```

##SDY364
[SDY364](https://www.immport.org/shared/study/SDY364) - Systems Biology Approach to Study Influenza Vaccine 2012-13 in Healthy Children (see companion studies SDY144, SDY368, SDY387). 

###MetaData
MetaData is extracted from the ImmPort data schema by querying the local database. First we build a local SQLite database instance and then query the database. The table below shows the filtered out data. To retrieve this meta data, file_info, expsample_2_file_info,  expsample_2_biosample, biosample, arm_2_subject and subject tables were queried from the database.

```{r, include=FALSE}
sdy <- "SDY364"
##Set tab_dir to the folder where the study files are located
studies_dir <- file.path(paste0("/Volumes/Samsung_T5/Immport_UH2/Companion_studies_1/"),sdy,"/Study")
tab_dir <- file.path(studies_dir,"Tab")
list.files(tab_dir)

##Set db dir to the folder where the database file "ImmPort.sqlite" should be stored
db_dir <- file.path(studies_dir,"Db")

##Build a local SQLite ImmPort database instance
#buildNewSqliteDb(tab_dir, db_dir)
list.files(db_dir)

sqlite_conn <- dbConnect(SQLite(), dbname=file.path(db_dir, "ImmPort.sqlite"))
setImmPortDataSource(sqlite_conn)
getListOfStudies()
```

```{r, include=FALSE, message=FALSE, warning=FALSE}
fcs_meta_Data <- dbGetQuery(sqlite_conn,"SELECT a.name, a.file_info_id, b.expsample_accession, b.file_info_id,
                            c.biosample_accession, c.expsample_accession, 
                            d.biosample_accession, d.study_time_collected, d.subject_accession, d.type,
                            e.subject_accession, e.max_subject_age,  f.ethnicity, f.race, f.description
                            FROM file_info a
                            INNER JOIN expsample_2_file_info b
                            ON a.file_info_id = b.file_info_id
                            INNER JOIN expsample_2_biosample c
                            ON c.expsample_accession = b.expsample_accession
                            INNER JOIN biosample d
                            ON d.biosample_accession = c.biosample_accession
                            INNER JOIN arm_2_subject e
                            ON e.subject_accession = d.subject_accession
                            INNER JOIN subject f
                            ON f.subject_accession = e.subject_accession
                            AND a.name LIKE '%.fcs%'
                            AND a.name NOT LIKE '%Compensation%';")
```

```{r}
kable(fcs_meta_Data)%>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "300px")
```

```{r, include=FALSE}
fcs_meta_Data <- unique(fcs_meta_Data[,-c(3,4,5,11)])
header_info <- read.xlsx("/Volumes/Samsung_T5/Immport_UH2/Companion_studies_1/SDY364/FCS/Header_SDY364.xlsx",sheet=1)                            
#colnames(header_info)[1] <- "name" 
mm_sdy364 <- merge(fcs_meta_Data, header_info, by="name")
final_tab_sdy364 <- mm_sdy364[which(mm_sdy364$Panel == "T"),]
```

All the files from SDY364 T-cell panel were used in the analysis. Table below shows subjects' data used in the analysis and the number of files in each visit. 0 represents missing data for that subject and visit
```{r,warning=FALSE,message=FALSE}
kable(dcast(final_tab_sdy364[,c(1,5,6)],subject_accession~study_time_collected,fun.aggregate = length))%>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "300px")
```

Data Description: 
There are 64 files from 17 subjects. Below is the data summary for the files, showing the number of files for each covariate.
```{r, message=FALSE}
lapply(final_tab_sdy364[,-c(1,2,3,4,7,11,12,13,14,15)],table)
```

###Antibody titer
Antibody titer for SDY364: Responders vs Non-responders: titer >= 40 are responders and titer < 40 are non-responders at Visit 28. Fold change is calculated as $\frac{Geometric mean of Ab titer of all strains on Day 28}{Geometric mean of Ab titer of all strains on Day 0}$.
```{r, include=FALSE}
ab_titer_sdy364 <- read.table("/Volumes/Samsung_T5/Immport_UH2/Companion_studies_1/SDY364/Study/Tab/SDY364-DR29_Tab/Tab/hai_result.txt",sep = "\t", header=TRUE)
ab_titer_d_sdy364 <- dcast(ab_titer_sdy364,SUBJECT_ACCESSION+STUDY_TIME_COLLECTED~VIRUS_STRAIN_REPORTED,value.var='VALUE_REPORTED',fun.aggregate = geometric.mean)
ab_titer_d_sdy364$Geometric_mean <- apply(ab_titer_d_sdy364[,3:5],1,function(x) geometric.mean(x,na.rm=TRUE))
resp_sdy364 <- dcast(ab_titer_d_sdy364,SUBJECT_ACCESSION~STUDY_TIME_COLLECTED,value.var='Geometric_mean')
resp_sdy364$FoldChange <- resp_sdy364$`28`/(resp_sdy364$`0`+0.00001)
resp_sdy364$responder0 <- cut(resp_sdy364$`0`, breaks = c(0,40,max(na.omit(resp_sdy364$`0`))), labels=c("NonResponder","Responder"))
resp_sdy364$responder28 <- cut(resp_sdy364$`28`, breaks = c(0,40,max(na.omit(resp_sdy364$`28`))), labels=c("NonResponder","Responder"))
resp_sdy364$responderFC <- cut(resp_sdy364$FoldChange, breaks = c(0,4,max(na.omit(resp_sdy364$FoldChange))), labels = c("NonResponder","Responder"))
resp_sdy364$responder_Day0_FC <- ifelse(resp_sdy364$responder0 == "Responder" | resp_sdy364$responderFC == "Responder","Responder","NonResponder")
colnames(resp_sdy364)[1] <- "subject_accession"
```

```{r}
###Print the ab titer table
kable(resp_sdy364)%>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "300px")
```

Line Plots for ab-titer across the time points. Colors indicate responder or non-responder based on Day28 titer (> 40 is a responder)
```{r}
melt_response <- melt(resp_sdy364[,c(1:3,6)],id=c("subject_accession","responder28"))
ggplot(na.omit(melt_response),aes(x=variable,y=value,group=subject_accession,color=responder28))+geom_line()+geom_point()+xlab("Day")+ylab("titer")+ggtitle("Antibody response across time points")+theme(text=element_text(size=10,family="Times"))
```

```{r comment=''}
#kable(read.table('inclusion_SDY364.config'), sep = '\t', header=TRUE)
```
Gating co-ordinates for SDY364
![alt text](/Volumes/Samsung_T5/Immport_UH2/Results_Analysis/MemoryCD4_CD8/SDY364_config.png)

Gating hierarchy used to identify the cell populations (example: SUB135676 at Day 7)
![alt text](/Volumes/Samsung_T5/Immport_UH2/Results_Analysis/MemoryCD4_CD8/SDY364_1.png)
![alt text](/Volumes/Samsung_T5/Immport_UH2/Results_Analysis/MemoryCD4_CD8/SDY364_2.png)

![alt text](/Volumes/Samsung_T5/Immport_UH2/Results_Analysis/MemoryCD4_CD8/SDY364_3.png)

![alt text](/Volumes/Samsung_T5/Immport_UH2/Results_Analysis/MemoryCD4_CD8/SDY364_4.png)

###Cell Proportions
```{r, include=FALSE}
#####Read the files########
sdy364 <- read.xlsx("/Volumes/Samsung_T5/Immport_UH2/Results_Analysis/MemoryCD4_CD8/SDY364_MemoryTcells.xlsx",sheet=2)[,-1]
sdy364$study_time_collected <- paste0("Day_",sdy364$study_time_collected)
melt_sdy364 <- melt(sdy364,id=c("name","study_time_collected","subject_accession","max_subject_age","Study"))
colnames(melt_sdy364)[6:7] <- c("CellType","CellProportion")
cast_sdy364 <- dcast(melt_sdy364,subject_accession+max_subject_age+CellType+Study~study_time_collected,value.var='CellProportion',fun.aggregate = mean)
colnames(resp_sdy364)[1] <- "subject_accession"
data_sdy364 <- left_join(cast_sdy364, resp_sdy364, by='subject_accession')
data_sdy364$Age_cat <- cut(data_sdy364$max_subject_age, breaks = c(0,60,120), labels = c("young","old"))
melt_data_sdy364 <- melt(data_sdy364[,-c(13,15,16)],id=c("subject_accession","max_subject_age","CellType","Study","0","28","FoldChange","responder28","Age_cat"))
```

```{r, warning=FALSE, message=FALSE}
for(i in 1:length(unique(data_sdy364$CellType))){
  data <- data_sdy364[data_sdy364$CellType == unique(data_sdy364$CellType)[i],]
  #data$variable <- factor(data$variable,levels = c("Day_0","Day_1","Day_7","Day_28","Day_40"))
  data_m <- melt_data_sdy364[melt_data_sdy364$CellType == unique(data_sdy364$CellType)[i],]
  data_m$variable <- factor(data_m$variable,levels = c("Day_0","Day_1","Day_7","Day_28","Day_40"))
p <- ggplot(na.omit(data_m),aes(x=as.factor(variable),y=value, group=subject_accession, color=responder28))+geom_line()+geom_point()+ggtitle(paste0("Cell Proportions across visits for ",unique(data_sdy364$CellType)[i]))+xlab("Visit")+ylab("Cell Proportion")+theme(text=element_text(size=10,  family="Times"))
print(p)
  p1<-ggscatter(data,x="Day_0",y="FoldChange",add = "reg.line", conf.int = TRUE, 
            cor.coef = TRUE, cor.method = "pearson",xlab="Cell Proportion", ylab="Ab Titer Fold Change",title = paste0(unique(data_sdy364$CellType)[i]," at Day 0"))+font("title",size=11)+theme(text=element_text(size=10,  family="Times"))
  
  p2<-ggscatter(data,x="Day_1",y="FoldChange",add = "reg.line", conf.int = TRUE, 
            cor.coef = TRUE, cor.method = "pearson",xlab="Cell Proportion", ylab="Ab Titer Fold Change",title = paste0(unique(data_sdy364$CellType)[i]," at Day 1"))+font("title",size=11)+theme(text=element_text(size=10,  family="Times"))
  
  p3<-ggscatter(data,x="Day_7",y="FoldChange",add = "reg.line", conf.int = TRUE, 
            cor.coef = TRUE, cor.method = "pearson",xlab="Cell Proportion", ylab="Ab Titer Fold Change",title = paste0(unique(data_sdy364$CellType)[i]," at Day 7"))+font("title",size=11)+theme(text=element_text(size=10,  family="Times"))
  
  p4<-ggscatter(data,x="Day_28",y="FoldChange",add = "reg.line", conf.int = TRUE, 
            cor.coef = TRUE, cor.method = "pearson",xlab="Cell Proportion", ylab="Ab Titer Fold Change",title = paste0(unique(data_sdy364$CellType)[i]," at Day 28"))+font("title",size=11)+theme(text=element_text(size=10,  family="Times"))
  
  grid.arrange(p1,p2,p3,p4, ncol=2)
  }
```

##SDY368
[SDY368](https://www.immport.org/shared/study/SDY368) - Systems Biology Approach to Study Influenza Vaccine 2012-13 in Healthy Children (see companion studies SDY144, SDY364, SDY387). 

###MetaData
MetaData is extracted from the ImmPort data schema by querying the local database. First we build a local SQLite database instance and then query the database. The table below shows the filtered out data. To retrieve this meta data, file_info, expsample_2_file_info,  expsample_2_biosample, biosample, arm_2_subject and subject tables were queried from the database.

```{r, include=FALSE}
sdy <- "SDY368"
##Set tab_dir to the folder where the study files are located
studies_dir <- file.path(paste0("/Volumes/Samsung_T5/Immport_UH2/Companion_studies_1/"),sdy,"/Study")
tab_dir <- file.path(studies_dir,"Tab")
list.files(tab_dir)

##Set db dir to the folder where the database file "ImmPort.sqlite" should be stored
db_dir <- file.path(studies_dir,"Db")

##Build a local SQLite ImmPort database instance
#buildNewSqliteDb(tab_dir, db_dir)
list.files(db_dir)

sqlite_conn <- dbConnect(SQLite(), dbname=file.path(db_dir, "ImmPort.sqlite"))
setImmPortDataSource(sqlite_conn)
getListOfStudies()
```

```{r, include=FALSE, message=FALSE, warning=FALSE}
fcs_meta_Data <- dbGetQuery(sqlite_conn,"SELECT a.name, a.file_info_id, b.expsample_accession, b.file_info_id,
                            c.biosample_accession, c.expsample_accession, 
                            d.biosample_accession, d.study_time_collected, d.subject_accession, d.type,
                            e.subject_accession, e.max_subject_age,  f.ethnicity, f.race, f.description
                            FROM file_info a
                            INNER JOIN expsample_2_file_info b
                            ON a.file_info_id = b.file_info_id
                            INNER JOIN expsample_2_biosample c
                            ON c.expsample_accession = b.expsample_accession
                            INNER JOIN biosample d
                            ON d.biosample_accession = c.biosample_accession
                            INNER JOIN arm_2_subject e
                            ON e.subject_accession = d.subject_accession
                            INNER JOIN subject f
                            ON f.subject_accession = e.subject_accession
                            AND a.name LIKE '%.fcs%'
                            AND a.name NOT LIKE '%Compensation%';")
fcs_meta_Data$name <- str_replace_all(fcs_meta_Data$name, pattern =" ", repl="")
```

```{r}
kable(fcs_meta_Data)%>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "300px")
```

```{r, include=FALSE}
fcs_meta_Data <- unique(fcs_meta_Data[,-c(2,3,5)])
header_info <- read.table("/Volumes/Samsung_T5/Immport_UH2/Companion_studies_1/SDY368/SDY368mapping.txt",header=T)
colnames(header_info)[1] <- "name" 
mm_sdy368 <- merge(fcs_meta_Data, header_info, by="name")
final_tab_sdy368 <- mm_sdy368[which(mm_sdy368$Panel == "Tfh"),]
```

All the files from SDY368 T-cell panel were used in the analysis. Table below shows subjects' data used in the analysis and the number of files in each visit. 0 represents missing data for that subject and visit
```{r,warning=FALSE,message=FALSE}
kable(dcast(final_tab_sdy368[,c(1,5,6)],subject_accession~study_time_collected,fun.aggregate = length))%>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "300px")
```

Data Description: 
There are 88 files from 22 subjects. Below is the data summary for the files, showing the number of files for each covariate.
```{r, message=FALSE}
lapply(final_tab_sdy368[,-c(1,2,3,4,7,8,12,13,14,15)],table)
```

###Antibody titer
Antibody titer for SDY368: Responders vs Non-responders: titer >= 40 are responders and titer < 40 are non-responders at Day 28. Fold change is calculated as $\frac{Geometric mean of Ab titer of all strains on Day 28}{Geometric mean of Ab titer of all strains on Day 0}$.
```{r, include=FALSE}
ab_titer_sdy368 <- read.table("/Volumes/Samsung_T5/Immport_UH2/Companion_studies_1/SDY368/Study/Tab/SDY368-DR29_Tab/Tab/neut_ab_titer_result.txt",sep = "\t", header=TRUE)
ab_titer_d_sdy368 <- dcast(ab_titer_sdy368,SUBJECT_ACCESSION+STUDY_TIME_COLLECTED~VIRUS_STRAIN_REPORTED,value.var='VALUE_REPORTED',fun.aggregate = geometric.mean)
ab_titer_d_sdy368$Geometric_mean <- apply(ab_titer_d_sdy368[,3:5],1,function(x) geometric.mean(x,na.rm=TRUE))
resp_sdy368 <- dcast(ab_titer_d_sdy368,SUBJECT_ACCESSION~STUDY_TIME_COLLECTED,value.var='Geometric_mean')
resp_sdy368$FoldChange <- resp_sdy368$`28`/(resp_sdy368$`0`+0.00001)
resp_sdy368$responder0 <- cut(resp_sdy368$`0`, breaks = c(0,40,max(na.omit(resp_sdy368$`0`))), labels=c("NonResponder","Responder"))
resp_sdy368$responder28 <- cut(resp_sdy368$`28`, breaks = c(0,40,max(na.omit(resp_sdy368$`28`))), labels=c("NonResponder","Responder"))
resp_sdy368$responderFC <- cut(resp_sdy368$FoldChange, breaks = c(0,4,max(na.omit(resp_sdy368$FoldChange))), labels = c("NonResponder","Responder"))
resp_sdy368$responder_Day0_FC <- ifelse(resp_sdy368$responder0 == "Responder" | resp_sdy368$responderFC == "Responder","Responder","NonResponder")
colnames(resp_sdy368)[1] <- "subject_accession"
```

```{r}
###Print the ab titer table
kable(resp_sdy368)%>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "300px")
```

Line Plots for ab-titer across the time points. Colors indicate responder or non-responder based on Day28 titer (> 40 is a responder). All the subjects are responders. 
```{r}
melt_response <- melt(resp_sdy368[,c(1:3,6)],id=c("subject_accession","responder28"))
ggplot(na.omit(melt_response),aes(x=variable,y=value,group=subject_accession,color=responder28))+geom_line()+geom_point()+xlab("Day")+ylab("titer")+ggtitle("Antibody response across time points")+theme(text=element_text(size=10,family="Times"))
```

Also looking at the response based on titer values at Day 0. 
```{r}
melt_response <- melt(resp_sdy368[,c(1:3,5)],id=c("subject_accession","responder0"))
ggplot(na.omit(melt_response),aes(x=variable,y=value,group=subject_accession,color=responder0))+geom_line()+geom_point()+xlab("Day")+ylab("titer")+ggtitle("Antibody response across time points")+theme(text=element_text(size=10,family="Times"))
```

Gating co-ordinates for SDY368
![alt text](/Volumes/Samsung_T5/Immport_UH2/Results_Analysis/MemoryCD4_CD8/SDY368_config.png)
Gating hierarchy used to identify the cell populations (example: SUB135723 at Day 1)
![alt text](/Volumes/Samsung_T5/Immport_UH2/Results_Analysis/MemoryCD4_CD8/SDY368_1.png)

![alt text](/Volumes/Samsung_T5/Immport_UH2/Results_Analysis/MemoryCD4_CD8/SDY368_2.png)

![alt text](/Volumes/Samsung_T5/Immport_UH2/Results_Analysis/MemoryCD4_CD8/SDY368_3.png)

![alt text](/Volumes/Samsung_T5/Immport_UH2/Results_Analysis/MemoryCD4_CD8/SDY368_4.png)
###Cell Proportions:
Colors indicate responder or non-repsonder based on the titer values at Day 0. 
```{r, include=FALSE}
#####Read the files########
sdy368 <- read.xlsx("/Volumes/Samsung_T5/Immport_UH2/Results_Analysis/MemoryCD4_CD8/SDY368_MemoryTcells.xlsx",sheet=2)[,-1]
sdy368$study_time_collected <- paste0("Day_",sdy368$study_time_collected)
melt_sdy368 <- melt(sdy368,id=c("name","study_time_collected","subject_accession","max_subject_age","Study"))
colnames(melt_sdy368)[6:7] <- c("CellType","CellProportion")
cast_sdy368 <- dcast(melt_sdy368,subject_accession+max_subject_age+CellType+Study~study_time_collected,value.var='CellProportion',fun.aggregate = mean)
colnames(resp_sdy368)[1] <- "subject_accession"
data_sdy368 <- left_join(cast_sdy368, resp_sdy368, by='subject_accession')
data_sdy368$Age_cat <- cut(data_sdy368$max_subject_age, breaks = c(0,60,120), labels = c("young","old"))
melt_data_sdy368 <- melt(data_sdy368[,-c(13,14,15)],id=c("subject_accession","max_subject_age","CellType","Study","0","28","FoldChange","responder0","Age_cat"))
```

```{r, warning=FALSE, message=FALSE}
for(i in 1:length(unique(data_sdy368$CellType))){
  data <- data_sdy368[data_sdy368$CellType == unique(data_sdy368$CellType)[i],]
  #data$variable <- factor(data$variable,levels = c("Day_0","Day_1","Day_7","Day_28","Day_40"))
  data_m <- melt_data_sdy368[melt_data_sdy368$CellType == unique(data_sdy368$CellType)[i],]
  data_m$variable <- factor(data_m$variable,levels = c("Day_0","Day_1","Day_7","Day_28","Day_40"))
p <- ggplot(na.omit(data_m),aes(x=as.factor(variable),y=value, group=subject_accession, color=responder0))+geom_line()+geom_point()+ggtitle(paste0("Cell Proportions across visits for ",unique(data_sdy368$CellType)[i]))+xlab("Visit")+ylab("Cell Proportion")
print(p)
  p1<-ggscatter(data,x="Day_0",y="FoldChange",add = "reg.line", conf.int = TRUE, 
            cor.coef = TRUE, cor.method = "pearson",xlab="Cell Proportion", ylab="Ab Titer Fold Change",title = paste0(unique(data_sdy368$CellType)[i]," at Day 0"))+font("title",size=11)+theme(text=element_text(size=10,family="Times"))
  
  p2<-ggscatter(data,x="Day_1",y="FoldChange",add = "reg.line", conf.int = TRUE, 
            cor.coef = TRUE, cor.method = "pearson",xlab="Cell Proportion", ylab="Ab Titer Fold Change",title = paste0(unique(data_sdy368$CellType)[i]," at Day 1"))+font("title",size=11)+theme(text=element_text(size=10,family="Times"))
  
  p3<-ggscatter(data,x="Day_7",y="FoldChange",add = "reg.line", conf.int = TRUE, 
            cor.coef = TRUE, cor.method = "pearson",xlab="Cell Proportion", ylab="Ab Titer Fold Change",title = paste0(unique(data_sdy368$CellType)[i]," at Day 7"))+font("title",size=11)+theme(text=element_text(size=10,family="Times"))
  
  p4<-ggscatter(data,x="Day_28",y="FoldChange",add = "reg.line", conf.int = TRUE, 
            cor.coef = TRUE, cor.method = "pearson",xlab="Cell Proportion", ylab="Ab Titer Fold Change",title = paste0(unique(data_sdy368$CellType)[i]," at Day 28"))+font("title",size=11)+theme(text=element_text(size=10,family="Times"))
  
  grid.arrange(p1,p2,p3,p4, ncol=2)
  }
```

##SDY387
[SDY387](https://www.immport.org/shared/study/SDY387) - Systems Biology Approach to Study Influenza Vaccine 2010-11 in Healthy Children (see companion studies SDY144, SDY364, SDY368). Related published article can be accessed [here](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3621097/pdf/nihms-457255.pdf).

###MetaData
MetaData is extracted from the ImmPort data schema by querying the local database. First we build a local SQLite database instance and then query the database. The table below shows the filtered out data. To retrieve this meta data, file_info, expsample_2_file_info,  expsample_2_biosample, biosample, arm_2_subject and subject tables were queried from the database.

```{r, include=FALSE}
sdy <- "SDY387"
##Set tab_dir to the folder where the study files are located
studies_dir <- file.path(paste0("/Volumes/Samsung_T5/Immport_UH2/Companion_studies_1/"),sdy,"/Study")
tab_dir <- file.path(studies_dir,"Tab")
list.files(tab_dir)

##Set db dir to the folder where the database file "ImmPort.sqlite" should be stored
db_dir <- file.path(studies_dir,"Db")

##Build a local SQLite ImmPort database instance
#buildNewSqliteDb(tab_dir, db_dir)
list.files(db_dir)

sqlite_conn <- dbConnect(SQLite(), dbname=file.path(db_dir, "ImmPort.sqlite"))
setImmPortDataSource(sqlite_conn)
getListOfStudies()
```


```{r, include=FALSE, message=FALSE, warning=FALSE}
fcs_meta_Data <- dbGetQuery(sqlite_conn,"SELECT a.name, a.file_info_id, b.expsample_accession, b.file_info_id,
                            c.biosample_accession, c.expsample_accession, 
                            d.biosample_accession, d.study_time_collected, d.subject_accession, d.type,
                            e.subject_accession, e.max_subject_age,  f.ethnicity, f.race, f.description
                            FROM file_info a
                            INNER JOIN expsample_2_file_info b
                            ON a.file_info_id = b.file_info_id
                            INNER JOIN expsample_2_biosample c
                            ON c.expsample_accession = b.expsample_accession
                            INNER JOIN biosample d
                            ON d.biosample_accession = c.biosample_accession
                            INNER JOIN arm_2_subject e
                            ON e.subject_accession = d.subject_accession
                            INNER JOIN subject f
                            ON f.subject_accession = e.subject_accession
                            AND a.name LIKE '%.fcs%'
                            AND a.name NOT LIKE '%Compensation%';")

fcs_meta_Data$name <- str_replace_all(fcs_meta_Data$name, pattern =" ", repl="")
```

```{r}
kable(fcs_meta_Data)%>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "300px")
```

```{r, include=FALSE}
fcs_meta_Data <- unique(fcs_meta_Data[,-c(2,3,5)])
header_info <- read.table("/Volumes/Samsung_T5/Immport_UH2/Companion_studies_1/SDY387/SDY387mapping.txt",header=T)
colnames(header_info)[1] <- "name" 
mm_sdy387 <- merge(fcs_meta_Data, header_info, by="name")
final_tab_sdy387 <- mm_sdy387[which(mm_sdy387$Panel == "TFH"),]
```

All the files from SDY387 T-cell panel were used in the analysis. Table below shows subjects' data used in the analysis and the number of files in each visit. 0 represents missing data for that subject and visit
```{r,warning=FALSE,message=FALSE}
kable(dcast(final_tab_sdy387[,c(1,5,6)],subject_accession~study_time_collected,fun.aggregate = length))%>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "300px")
```

Data Description: 
There are 82 files from 20 subjects. Below is the data summary for the files, showing the number of files for each covariate.
```{r, message=FALSE}
lapply(final_tab_sdy387[,-c(1,2,3,4,7,8,12,13,14,15)],table)
```

###Antibody titer
Antibody titer for SDY387: Responders vs Non-responders: titer >= 40 are responders and titer < 40 are non-responders at Day 28. Fold change is calculated as $\frac{Geometric mean of Ab titer of all strains on Day 28}{Geometric mean of Ab titer of all strains on Day 0}$.
```{r, include=FALSE}
ab_titer_sdy387 <- read.table("/Volumes/Samsung_T5/Immport_UH2/Companion_studies_1/SDY387/Study/Tab/SDY387-DR29_Tab/Tab/neut_ab_titer_result.txt",sep = "\t", header=TRUE)
ab_titer_d_sdy387 <- dcast(ab_titer_sdy387,SUBJECT_ACCESSION+STUDY_TIME_COLLECTED~VIRUS_STRAIN_REPORTED,value.var='VALUE_REPORTED',fun.aggregate = geometric.mean)
ab_titer_d_sdy387$Geometric_mean <- apply(ab_titer_d_sdy387[,3:5],1,function(x) geometric.mean(x,na.rm=TRUE))
resp_sdy387 <- dcast(ab_titer_d_sdy387,SUBJECT_ACCESSION~STUDY_TIME_COLLECTED,value.var='Geometric_mean')
resp_sdy387$FoldChange <- resp_sdy387$`28`/(resp_sdy387$`0`+0.00001)
resp_sdy387$responder0 <- cut(resp_sdy387$`0`, breaks = c(0,40,max(na.omit(resp_sdy387$`0`))), labels=c("NonResponder","Responder"))
resp_sdy387$responder28 <- cut(resp_sdy387$`28`, breaks = c(0,40,max(na.omit(resp_sdy387$`28`))), labels=c("NonResponder","Responder"))
resp_sdy387$responderFC <- cut(resp_sdy387$FoldChange, breaks = c(0,4,max(na.omit(resp_sdy387$FoldChange))), labels = c("NonResponder","Responder"))
resp_sdy387$responder_Day0_FC <- ifelse(resp_sdy387$responder0 == "Responder" | resp_sdy387$responderFC == "Responder","Responder","NonResponder")
colnames(resp_sdy387)[1] <- "subject_accession"
```

```{r}
###Print the ab titer table
kable(resp_sdy387)%>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "300px")
```

Line Plots for ab-titer across the time points. Colors indicate responder or non-responder based on Day28 titer (> 40 is a responder). ALl the subjects are responders. 
```{r}
melt_response <- melt(resp_sdy387[,c(1:3,6)],id=c("subject_accession","responder28"))
ggplot(na.omit(melt_response),aes(x=variable,y=value,group=subject_accession,color=responder28))+geom_line()+geom_point()+xlab("Day")+ylab("titer")+ggtitle("Antibody response across time points")+theme(text=element_text(size=10,family="Times"))
```
Also looking at the response based on titer values at Day 0. 
```{r}
melt_response <- melt(resp_sdy387[,c(1:3,5)],id=c("subject_accession","responder0"))
ggplot(na.omit(melt_response),aes(x=variable,y=value,group=subject_accession,color=responder0))+geom_line()+geom_point()+xlab("Day")+ylab("titer")+ggtitle("Antibody response across time points")+theme(text=element_text(size=10,family="Times"))
```

Gating co-ordinates for SDY387
![alt text](/Volumes/Samsung_T5/Immport_UH2/Results_Analysis/MemoryCD4_CD8/SDY387_config.png)
Gating hierarchy used to identify the cell populations (example: SUB135881 at Day 90)
![alt text](/Volumes/Samsung_T5/Immport_UH2/Results_Analysis/MemoryCD4_CD8/SDY387_1.png)

![alt text](/Volumes/Samsung_T5/Immport_UH2/Results_Analysis/MemoryCD4_CD8/SDY387_2.png)

![alt text](/Volumes/Samsung_T5/Immport_UH2/Results_Analysis/MemoryCD4_CD8/SDY387_3.png)

![alt text](/Volumes/Samsung_T5/Immport_UH2/Results_Analysis/MemoryCD4_CD8/SDY387_4.png)

###Cell Proportions:
Colors indicate responder or non-repsonder based on the titer values at Day 0. 
```{r, include=FALSE}
#####Read the files########
sdy387 <- read.xlsx("/Volumes/Samsung_T5/Immport_UH2/Results_Analysis/MemoryCD4_CD8/SDY387_MemoryTcells.xlsx",sheet=3)[,-1]
sdy387$study_time_collected <- paste0("Day_",sdy387$study_time_collected)
melt_sdy387 <- melt(sdy387,id=c("name","study_time_collected","subject_accession","max_subject_age","Study"))
colnames(melt_sdy387)[6:7] <- c("CellType","CellProportion")
cast_sdy387 <- dcast(melt_sdy387,subject_accession+max_subject_age+CellType+Study~study_time_collected,value.var='CellProportion',fun.aggregate = mean)
colnames(resp_sdy387)[1] <- "subject_accession"
data_sdy387 <- left_join(cast_sdy387, resp_sdy387, by='subject_accession')
data_sdy387$Age_cat <- cut(data_sdy387$max_subject_age, breaks = c(0,60,120), labels = c("young","old"))
melt_data_sdy387 <- melt(data_sdy387[,-c(14:16)],id=c("subject_accession","max_subject_age","CellType","Study","0","28","FoldChange","responder0","Age_cat"))
```

```{r, warning=FALSE, message=FALSE}
for(i in 1:length(unique(data_sdy387$CellType))){
  data <- data_sdy387[data_sdy387$CellType == unique(data_sdy387$CellType)[i],]
  #data$variable <- factor(data$variable,levels = c("Day_0","Day_1","Day_7","Day_28","Day_40"))
  data_m <- melt_data_sdy387[melt_data_sdy387$CellType == unique(data_sdy387$CellType)[i],]
  data_m$variable <- factor(data_m$variable,levels = c("Day_0","Day_7","Day_28","Day_90","Day_180"))
p <- ggplot(na.omit(data_m),aes(x=as.factor(variable),y=value, group=subject_accession, color=responder0))+geom_line()+geom_point()+ggtitle(paste0("Cell Proportions across visits for ",unique(data_sdy387$CellType)[i]))+xlab("Visit")+ylab("Cell Proportion")
print(p)
  p1<-ggscatter(data,x="Day_0",y="FoldChange",add = "reg.line", conf.int = TRUE, 
            cor.coef = TRUE, cor.method = "pearson",xlab="Cell Proportion", ylab="Ab Titer Fold Change",title = paste0(unique(data_sdy387$CellType)[i]," at Day 0"))+font("title",size=11)+theme(text=element_text(size=10,family="Times"))
  
  p2<-ggscatter(data,x="Day_7",y="FoldChange",add = "reg.line", conf.int = TRUE, 
            cor.coef = TRUE, cor.method = "pearson",xlab="Cell Proportion", ylab="Ab Titer Fold Change",title = paste0(unique(data_sdy387$CellType)[i]," at Day 7"))+font("title",size=11)+theme(text=element_text(size=10,family="Times"))
  
  p3<-ggscatter(data,x="Day_28",y="FoldChange",add = "reg.line", conf.int = TRUE, 
            cor.coef = TRUE, cor.method = "pearson",xlab="Cell Proportion", ylab="Ab Titer Fold Change",title = paste0(unique(data_sdy387$CellType)[i]," at Day 28"))+font("title",size=11)+theme(text=element_text(size=10,family="Times"))
  
  p4<-ggscatter(data,x="Day_90",y="FoldChange",add = "reg.line", conf.int = TRUE, 
            cor.coef = TRUE, cor.method = "pearson",xlab="Cell Proportion", ylab="Ab Titer Fold Change",title = paste0(unique(data_sdy387$CellType)[i]," at Day 90"))+font("title",size=11)+theme(text=element_text(size=10,family="Times"))
  
   p5<-ggscatter(data,x="Day_180",y="FoldChange",add = "reg.line", conf.int = TRUE, 
            cor.coef = TRUE, cor.method = "pearson",xlab="Cell Proportion", ylab="Ab Titer Fold Change",title = paste0(unique(data_sdy387$CellType)[i]," at Day 180"))+font("title",size=11)+theme(text=element_text(size=10,family="Times"))
   
  grid.arrange(p1,p2,p3,p4,p5, ncol=2)
  }
```

##SDY404
[SDY404](https://www.immport.org/shared/study/SDY404) - Immunologic and genomic signatures of influenza vaccine response - 2011 (see companion studies SDY63, SDY400, SDY520). Related published article can be accessed [here](https://academic.oup.com/jid/article/211/7/1174/838329).

###MetaData
MetaData is extracted from the ImmPort data schema by querying the local database. First we build a local SQLite database instance and then query the database. The table below shows the filtered out data. To retrieve this meta data, file_info, expsample_2_file_info,  expsample_2_biosample, biosample, arm_2_subject and subject tables were queried from the database.

```{r, include=FALSE}
sdy <- "SDY404"
##Set tab_dir to the folder where the study files are located
studies_dir <- file.path(paste0("/Volumes/Samsung_T5/Immport_UH2/"),sdy,"/Study")
tab_dir <- file.path(studies_dir,"Tab")
list.files(tab_dir)

##Set db dir to the folder where the database file "ImmPort.sqlite" should be stored
db_dir <- file.path(studies_dir,"Db")

##Build a local SQLite ImmPort database instance
#buildNewSqliteDb(tab_dir, db_dir)
list.files(db_dir)

sqlite_conn <- dbConnect(SQLite(), dbname=file.path(db_dir, "ImmPort.sqlite"))
setImmPortDataSource(sqlite_conn)
getListOfStudies()
```


```{r, include=FALSE, message=FALSE, warning=FALSE}
fcs_meta_Data <- dbGetQuery(sqlite_conn,"SELECT a.name, a.file_info_id, b.expsample_accession, b.file_info_id,
                            c.biosample_accession, c.expsample_accession, 
                            d.biosample_accession, d.study_time_collected, d.subject_accession, d.type,
                            e.subject_accession, e.max_subject_age,  f.ethnicity, f.race, f.description
                            FROM file_info a
                            INNER JOIN expsample_2_file_info b
                            ON a.file_info_id = b.file_info_id
                            INNER JOIN expsample_2_biosample c
                            ON c.expsample_accession = b.expsample_accession
                            INNER JOIN biosample d
                            ON d.biosample_accession = c.biosample_accession
                            INNER JOIN arm_2_subject e
                            ON e.subject_accession = d.subject_accession
                            INNER JOIN subject f
                            ON f.subject_accession = e.subject_accession
                            AND a.name LIKE '%.fcs%'
                            AND a.name NOT LIKE '%Compensation%';")
```

```{r}
kable(fcs_meta_Data)%>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "300px")
```

```{r, include=FALSE}
fcs_meta_Data <- unique(fcs_meta_Data[,-c(2,3,5)])
header_info <- read.xlsx("/Volumes/Samsung_T5/Immport_UH2/SDY404/Header_SDY404.xlsx",sheet=1)
colnames(header_info)[1] <- "name" 
mm_sdy404 <- merge(fcs_meta_Data, header_info, by="name")
final_tab_sdy404 <- mm_sdy404[which(mm_sdy404$Panel == "7"),]
```

All the files from SDY404 T-cell panel were used in the analysis. Table below shows subjects' data used in the analysis and the number of files in each visit. 0 represents missing data for that subject and visit
```{r,warning=FALSE,message=FALSE}
kable(dcast(final_tab_sdy404[,c(1,5,6)],subject_accession~study_time_collected,fun.aggregate = length))%>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "300px")
```

Data Description: 
There are 207 files from 53 subjects. Below is the data summary for the files, showing the number of files for each covariate.
```{r, message=FALSE}
lapply(final_tab_sdy404[,-c(1,2,3,4,7,8,12,13,14,15)],table)
```

###Antibody titer
Antibody titer for SDY404: Responders vs Non-responders: titer >= 40 are responders and titer < 40 are non-responders at Visit 0. Fold change is calculated as $\frac{Geometric mean of Ab titer of all strains on Day 28}{Geometric mean of Ab titer of all strains on Day 0}$.
```{r, include=FALSE}
ab_titer_sdy404 <- read.table("/Volumes/Samsung_T5/Immport_UH2/SDY404/Study/Tab/SDY404-DR29_Tab/Tab/hai_result.txt",sep = "\t", header=TRUE)
ab_titer_d_sdy404 <- dcast(ab_titer_sdy404,SUBJECT_ACCESSION+STUDY_TIME_COLLECTED~VIRUS_STRAIN_REPORTED,value.var='VALUE_REPORTED',fun.aggregate = geometric.mean)
ab_titer_d_sdy404$Geometric_mean <- apply(ab_titer_d_sdy404[,3:5],1,function(x) geometric.mean(x,na.rm=TRUE))
resp_sdy404 <- dcast(ab_titer_d_sdy404,SUBJECT_ACCESSION~STUDY_TIME_COLLECTED,value.var='Geometric_mean')
resp_sdy404$FoldChange <- resp_sdy404$`28`/(resp_sdy404$`0`+0.00001)
resp_sdy404$responder0 <- cut(resp_sdy404$`0`, breaks = c(0,40,max(na.omit(resp_sdy404$`0`))), labels=c("NonResponder","Responder"))
resp_sdy404$responder28 <- cut(resp_sdy404$`28`, breaks = c(0,40,max(na.omit(resp_sdy404$`28`))), labels=c("NonResponder","Responder"))
resp_sdy404$responderFC <- cut(resp_sdy404$FoldChange, breaks = c(0,4,max(na.omit(resp_sdy404$FoldChange))), labels = c("NonResponder","Responder"))
resp_sdy404$responder_Day0_FC <- ifelse(resp_sdy404$responder0 == "Responder" | resp_sdy404$responderFC == "Responder","Responder","NonResponder")
colnames(resp_sdy404)[1] <- "subject_accession"
```

```{r}
###Print the ab titer table
kable(resp_sdy404)%>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "300px")
```

Line Plots for ab-titer across the time points. Colors indicate responder or non-responder based on Day28 titer (> 40 is a responder). 
```{r}
melt_response <- melt(resp_sdy404[,c(1:7,10)],id=c("subject_accession","responder28"))
ggplot(na.omit(melt_response),aes(x=variable,y=value,group=subject_accession,color=responder28))+geom_line()+geom_point()+xlab("Day")+ylab("titer")+ggtitle("Antibody response across time points")+theme(text=element_text(size=10,family="Times"))
```

Gating co-ordinates for SDY404
![alt text](/Volumes/Samsung_T5/Immport_UH2/Results_Analysis/MemoryCD4_CD8/SDY404_config.png)
Gating hierarchy used to identify the cell populations (example: SUB120460 at Day 28)
![alt text](/Volumes/Samsung_T5/Immport_UH2/Results_Analysis/MemoryCD4_CD8/SDY404_1.png)

![alt text](/Volumes/Samsung_T5/Immport_UH2/Results_Analysis/MemoryCD4_CD8/SDY404_2.png)
![alt text](/Volumes/Samsung_T5/Immport_UH2/Results_Analysis/MemoryCD4_CD8/SDY404_3.png)
![alt text](/Volumes/Samsung_T5/Immport_UH2/Results_Analysis/MemoryCD4_CD8/SDY404_4.png)
###Cell Proportions:
Colors indicate responder or non-repsonder based on the titer values at Day 0. 
```{r, include=FALSE}
#####Read the files########
sdy404 <- read.xlsx("/Volumes/Samsung_T5/Immport_UH2/Results_Analysis/MemoryCD4_CD8/SDY404_MemoryTcells.xlsx",sheet=2)[,-1]
sdy404$study_time_collected <- paste0("Day_",sdy404$study_time_collected)
melt_sdy404 <- melt(sdy404,id=c("name","study_time_collected","subject_accession","max_subject_age","Study"))
colnames(melt_sdy404)[6:7] <- c("CellType","CellProportion")
cast_sdy404 <- dcast(melt_sdy404,subject_accession+max_subject_age+CellType+Study~study_time_collected,value.var='CellProportion',fun.aggregate = mean)
colnames(resp_sdy404)[1] <- "subject_accession"
data_sdy404 <- left_join(cast_sdy404, resp_sdy404, by='subject_accession')
data_sdy404$Age_cat <- cut(data_sdy404$max_subject_age, breaks = c(0,60,120), labels = c("young","old"))
melt_data_sdy404 <- melt(data_sdy404[,-c(6,8,9,11,12,13,22,24,25)],id=c("subject_accession","max_subject_age","CellType","Study","0","28","FoldChange","responder28","Age_cat"))
```

```{r, warning=FALSE, message=FALSE}
for(i in 1:length(unique(data_sdy404$CellType))){
  data <- data_sdy404[data_sdy404$CellType == unique(data_sdy404$CellType)[i],]
  #data$variable <- factor(data$variable,levels = c("Day_0","Day_1","Day_7","Day_28","Day_40"))
  data_m <- melt_data_sdy404[melt_data_sdy404$CellType == unique(data_sdy404$CellType)[i],]
  data_m$variable <- factor(data_m$variable,levels = c("Day_0","Day_2","Day_7","Day_28"))
p <- ggplot(na.omit(data_m),aes(x=as.factor(variable),y=value, group=subject_accession, color=responder28))+geom_line()+geom_point()+ggtitle(paste0("Cell Proportions across visits for ",unique(data_sdy404$CellType)[i]))+xlab("Visit")+ylab("Cell Proportion")+theme(text=element_text(size=10,family="Times"))
print(p)
  p1<-ggscatter(data,x="Day_0",y="FoldChange",add = "reg.line", conf.int = TRUE, 
            cor.coef = TRUE, cor.method = "pearson",xlab="Cell Proportion", ylab="Ab Titer Fold Change",title = paste0(unique(data_sdy404$CellType)[i]," at Day 0"))+font("title",size=11)+theme(text=element_text(size=10,family="Times"))
  
  p2<-ggscatter(data,x="Day_2",y="FoldChange",add = "reg.line", conf.int = TRUE, 
            cor.coef = TRUE, cor.method = "pearson",xlab="Cell Proportion", ylab="Ab Titer Fold Change",title = paste0(unique(data_sdy404$CellType)[i]," at Day 1"))+font("title",size=11)+theme(text=element_text(size=10,family="Times"))
  
  p3<-ggscatter(data,x="Day_7",y="FoldChange",add = "reg.line", conf.int = TRUE, 
            cor.coef = TRUE, cor.method = "pearson",xlab="Cell Proportion", ylab="Ab Titer Fold Change",title = paste0(unique(data_sdy404$CellType)[i]," at Day 7"))+font("title",size=11)+theme(text=element_text(size=10,family="Times"))
  
  p4<-ggscatter(data,x="Day_28",y="FoldChange",add = "reg.line", conf.int = TRUE, 
            cor.coef = TRUE, cor.method = "pearson",xlab="Cell Proportion", ylab="Ab Titer Fold Change",title = paste0(unique(data_sdy404$CellType)[i]," at Day 28"))+font("title",size=11)+theme(text=element_text(size=10,family="Times"))
  
  grid.arrange(p1,p2,p3,p4, ncol=2)
  }
```

##Summary

```{r,include=FALSE,warning=FALSE,message=FALSE}
Mem_Tcells_summ <- data.frame(
  Study = c("SDY144","SDY364","SDY368","SDY387","SDY404"),
  Visit_Day = c("0,1,7,28","0,1,7,28,40","0,1,7,28","0,7,28,90,140","0,2,3,4,7,17,21,24,28,35"),
  Virus_strain = c("A/California/7/09 H1N1; A/Perth/16/09 H3N2; B/Brisbane/60/08","A/California/07/09(H1N1); A/Victoria /361/2011(H3N2); B/Wisconsin","A/California/07/09(H1N1); A/Victoria /361/2011(H3N2); B/Massachusetts; B/Wisconsin","A/California/07/2009; B/Brisbane/60/2008; Perth/16/2009","A/California/07/2009; A/Perth/16/2009; B/Brisbane/60/2008"))
```

```{r}
kable(Mem_Tcells_summ) %>%
  kable_styling(full_width = F,c("striped","bordered")) %>%
  row_spec(1:5,hline_after = TRUE) %>%
  column_spec(1:ncol(cell_summ),border_left = T, border_right = T)
```

```{r, include=FALSE,message=FALSE,warning=FALSE}
############## Violin plot SDY144 SDY387 SDY404 ################
colnames(data_sdy144)[13] <- colnames(data_sdy387)[14] <- colnames(data_sdy404)[23] <- "responder28_30"
merged_tab <- rbind(data_sdy144[,intersect(colnames(data_sdy144),colnames(data_sdy387))],data_sdy387[,intersect(colnames(data_sdy144),colnames(data_sdy387))])
merged_tab <- rbind(merged_tab,data_sdy404[,intersect(colnames(data_sdy144),colnames(data_sdy404))])
day0_merged <- merged_tab[,c(1:5,8,10,13)]
day28_merged <- merged_tab[,c(1:4,6,8,10,13)]
day7_merged <- merged_tab[,c(1:4,7,8,10,13)]
melted_merged <- melt(na.omit(merged_tab[,-c(8,9,10,12,13)]),id=c("subject_accession","max_subject_age","CellType","Study","responder28_30","Age_cat"))
```

```{r,warning=FALSE,message=FALSE,fig.height = 8, fig.width = 10}
dodge <- position_dodge(width = 0.9)
melted_merged%>%
  ggplot(aes(x=variable,y=value,fill=Study))+
  geom_jitter(aes(group=Study,color=responder28_30),cex=0.3)+
  geom_violin(position="dodge",alpha=0.3)+scale_fill_viridis(discrete=T, name="")+
  geom_boxplot(width=0.1,outlier.colour=NA, position = dodge)+scale_x_discrete(limits=c("Day_0","Day_7","Day_28"))+
  facet_wrap(~CellType,scales = "free")+theme_get()+xlab("Visit")+ylab("Cell Proportion")+
  ggtitle("Cell proportion across SDY144, SDY387, SDY404")+theme(text=element_text(size=10,family="Times"))
```

```{r,include=FALSE,warning=FALSE,message=FALSE}
############## Violin plot SDY364 SDY368 ################
merged_tab <- rbind(data_sdy364[,intersect(colnames(data_sdy364),colnames(data_sdy368))],data_sdy368[,intersect(colnames(data_sdy364),colnames(data_sdy368))])

day0_merged <- merged_tab[,c(1:5,13.16)]
day1_merged <- merged_tab[,c(1:4,6,13,16)]
day28_merged <- merged_tab[,c(1:4,7,13,16)]
day7_merged <- merged_tab[,c(1:4,8,13,16)]
melted_merged <- melt(na.omit(merged_tab[,-c(9:12,14,15)]),id=c("subject_accession","max_subject_age","CellType","Study","responder28","Age_cat"))
```

```{r,warning=FALSE,message=FALSE,fig.height = 8, fig.width = 10}
dodge <- position_dodge(width = 0.9)
melted_merged %>%
  ggplot(aes(x=variable,y=value,fill=Study))+
  geom_jitter(aes(group=Study,color=responder28),cex=0.3)+
  geom_violin(position="dodge",alpha=0.3)+scale_fill_viridis(discrete=T, name="")+
  geom_boxplot(width=0.1,outlier.colour=NA, position = dodge)+scale_x_discrete(limits=c("Day_0","Day_1","Day_7","Day_28"))+
  facet_wrap(~CellType,scales = "free")+theme_get()+xlab("Visit")+ylab("Cell Proportion") +
  ggtitle("Cell proportion across SDY364, SDY368")+theme(text=element_text(size=10,family="Times"))
```

##Correlations

Table shows pearson correlations calculated across all the studies
```{r, include=FALSE}
corr_all <- data.frame(Study = c(rep("SDY144",4),rep("SDY364",4),rep("SDY368",4),rep("SDY387",5),rep("SDY404",4)),Visit=c(rep(c("Day0","Day1","Day7","Day28"),3),c("Day0","Day7","Day28","Day90","Day180"),c("Day0","Day1","Day7","Day28")),CD4p_Tcells=c("0.17","-0.0087","-0.084","-0.12","-0.29","0.16","0.0057","-0.027","0.03","0.012","-0.085","-0.047","0.029","0.13","-0.011","-0.023","-0.34","-0.073","-0.099","0.13","-0.12"),CD8p_Tcells=c("0.083","-0.08","0.036","0.0044","-0.5","-0.18","0.044","0.11","-0.19","-0.17","-0.073","-0.2","0.043","-0.059","0.034","-0.032","0.52","0.065","-0.076","-0.092","0.024"),CD4p_CD45RAn_CCR7n=c("-0.033","0.05","0.061","0.037","-0.28","0.016","-0.068","0.0094","0.0026","-0.2","-0.35","0.12","-0.12","-0.057","-0.23","-0.3","0.13","-0.04","0.14","-0.079","-0.086"),CD4p_CD45RAp_CCR7n=c("0.091","0.1","0.032","0.06","0.072","0.31","0.14","0.29","-0.18","-0.33","-0.27","-0.18","-0.33","-0.35","-0.22","-0.43","0.27","-0.12","0.016","0.067","-0.056"),CD4p_CD45RAn_CCR7p=c("0.62","-0.35","0.15","-0.0079","-0.31","-0.041","-0.058","-0.056","0.41","0.59","0.38","0.3","0.072","0.11","0.27","0.052","-0.12","0.0056","-0.096","0.0033","-0.085"),CD4p_CD45RAp_CCR7p=c("0.14","-0.035","-0.14","-0.13","-0.2","-0.038","-0.0094","-0.12","-0.18","-0.17","-0.07","-0.2","0.11","0.17","-0.012","0.24","-0.32","-0.05","-0.15","0.24","-0.02"),CD8p_CD45RAn_CCR7n=c("0.016","0.0013","-0.27","-0.29","-0.32","-0.13","-0.095","0.056","0.16","0.024","-0.22","0.41","-0.077","-0.18","-0.071","-0.42","-0.1","-0.086","-0.11","-0.12","-0.024"),CD8p_CD45RAp_CCR7n=c("0.14","0.21","-0.13","-0.06","-0.18","-0.062","-0.1","0.11","0.074","-0.081","-0.13","0.04","-0.066","-0.11","-0.036","-0.11","0.59","-0.15","-0.18","-0.19","-0.11"),CD8p_CD45RAn_CCR7p=c("0.07","-0.29","0.51","0.49","-0.47","-0.39","0.34","0.011","-0.22","0.082","-0.009","-0.057","-0.25","-0.33","-0.1","-0.37","0.5","0.0033","0.012","-0.16","-0.014"),CD8p_CD45RAp_CCR7p=c("-0.031","-0.091","0.1","0.029","-0.38","-0.096","0.23","0.03","-0.27","-0.2","0.086","-0.37","0.34","0.33","0.12","0.43","0.18","0.3","0.23","0.28","0.18"))
```

```{r, message=FALSE}
kable(corr_all, align = "c") %>%
  kable_styling(c("bordered"),full_width = F) %>%
  column_spec(1, bold = T) %>%
  collapse_rows(columns = 1:2, valign = "top")%>%
  column_spec(1:11,border_right = T)
```

